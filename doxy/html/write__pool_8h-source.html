<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>&lt;stxxl&gt;: write_pool.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a> | <a class="qindex" href="examples.html">Examples</a></div>
<h1>write_pool.h</h1><div class="fragment"><pre>00001 <span class="preprocessor"> #ifndef WRITE_POOL_HEADER</span>
00002 <span class="preprocessor"></span><span class="preprocessor"> #define WRITE_POOL_HEADER</span>
00003 <span class="preprocessor"></span> <span class="comment">/***************************************************************************</span>
00004 <span class="comment"> *            write_pool.h</span>
00005 <span class="comment"> *</span>
00006 <span class="comment"> *  Wed Jul  2 11:55:44 2003</span>
00007 <span class="comment"> *  Copyright  2003  Roman Dementiev</span>
00008 <span class="comment"> *  dementiev@mpi-sb.mpg.de</span>
00009 <span class="comment"> ****************************************************************************/</span>
00010 <span class="preprocessor">#include "../common/utils.h"</span>
00011 <span class="preprocessor">#include "../mng/mng.h"</span>
00012 <span class="preprocessor">#include &lt;list&gt;</span> 
00013 <span class="preprocessor">#include &lt;ext/hash_map&gt;</span>
00014  
00015 __STXXL_BEGIN_NAMESPACE
00016  
00019  
00020  
00022 <span class="keyword">template</span> &lt;<span class="keyword">class</span> BlockType&gt;
<a name="l00023"></a><a class="code" href="classstxxl_1_1write__pool.html">00023</a> <span class="keyword">class </span><a class="code" href="classstxxl_1_1write__pool.html">write_pool</a>
00024 {
00025 <span class="keyword">public</span>:
00026   <span class="keyword">typedef</span> BlockType block_type;
00027   <span class="keyword">typedef</span> <span class="keyword">typename</span> block_type::bid_type bid_type;
00028   
00029   <span class="comment">// a hack to make wait_any work with busy_entry type</span>
00030   <span class="keyword">struct </span>busy_entry
00031   {
00032     block_type * block;
00033     <a class="code" href="classstxxl_1_1request__ptr.html">request_ptr</a> req;
00034     bid_type bid;
00035     
00036     busy_entry(): block(NULL) {}
00037     busy_entry(<span class="keyword">const</span> busy_entry &amp; a): block(a.block),req(a.req),bid(a.bid) {}
00038     busy_entry(block_type * &amp; bl, <a class="code" href="classstxxl_1_1request__ptr.html">request_ptr</a> &amp; r, bid_type &amp; bi) :
00039       block(bl),req(r),bid(bi) { }
00040         
00041     operator request_ptr () { <span class="keywordflow">return</span> req; }
00042   };
00043   <span class="comment">//typedef __gnu_cxx::hash_map &lt; bid_type, request_ptr , bid_hash &gt; hash_map_type;</span>
00044   <span class="comment">//typedef typename hash_map_type::iterator block_track_iterator;</span>
00045   <span class="keyword">typedef</span> <span class="keyword">typename</span> std::list&lt;block_type *&gt;::iterator free_blocks_iterator;
00046   <span class="keyword">typedef</span> <span class="keyword">typename</span> std::list&lt;busy_entry&gt;::iterator busy_blocks_iterator;
00047 <span class="keyword">protected</span>:
00048    
00049   <span class="comment">// contains free write blocks</span>
00050   std::list&lt;block_type *&gt; free_blocks;
00051   <span class="comment">// blocks that are in writing</span>
00052         std::list&lt;busy_entry&gt; busy_blocks;
00053   
00054   <span class="comment">//hash_map_type block_track;</span>
00055   
00056   <span class="keywordtype">unsigned</span> free_blocks_size,busy_blocks_size;
00057 <span class="keyword">public</span>:
<a name="l00060"></a><a class="code" href="classstxxl_1_1write__pool.html#a0">00060</a>   <span class="keyword">explicit</span> <a class="code" href="classstxxl_1_1write__pool.html">write_pool</a>(<span class="keywordtype">unsigned</span> init_size=1):free_blocks_size(init_size),busy_blocks_size(0)
00061   {
00062     <span class="keywordtype">unsigned</span> i = 0;
00063     <span class="keywordflow">for</span>(;i&lt;init_size;++i)
00064       free_blocks.push_back(<span class="keyword">new</span> block_type);
00065   }
<a name="l00067"></a><a class="code" href="classstxxl_1_1write__pool.html#a1">00067</a>   <span class="keyword">virtual</span> ~<a class="code" href="classstxxl_1_1write__pool.html">write_pool</a>()
00068   {
00069     STXXL_VERBOSE2(<span class="stringliteral">"write_pool::~write_pool free_blocks_size: "</span>&lt;&lt;
00070       free_blocks_size&lt;&lt;<span class="stringliteral">" busy_blocks_size: "</span>&lt;&lt;busy_blocks_size)
00071     <span class="keywordflow">while</span>(!free_blocks.empty())
00072     {
00073       <span class="keyword">delete</span> free_blocks.back();
00074       free_blocks.pop_back();
00075     }
00076     
00077     busy_blocks_iterator i2 = busy_blocks.begin();
00078     <span class="keywordflow">for</span>(;i2 != busy_blocks.end();++i2)
00079     {
00080       i2-&gt;req-&gt;wait();
00081       <span class="keyword">delete</span> i2-&gt;block;
00082     }
00083   }
00084   
<a name="l00086"></a><a class="code" href="classstxxl_1_1write__pool.html#a2">00086</a>   <span class="keywordtype">unsigned</span> size()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> free_blocks_size + busy_blocks_size; }
00087   
<a name="l00094"></a><a class="code" href="classstxxl_1_1write__pool.html#a3">00094</a>   <a class="code" href="classstxxl_1_1request__ptr.html">request_ptr</a> write(block_type * block,bid_type bid)
00095   {
00096     <a class="code" href="classstxxl_1_1request__ptr.html">request_ptr</a> result = block-&gt;write(bid);
00097     ++busy_blocks_size;
00098     busy_blocks.push_back(busy_entry(block,result,bid));
00099     <span class="keywordflow">return</span> result;
00100   }
00101   
<a name="l00104"></a><a class="code" href="classstxxl_1_1write__pool.html#a4">00104</a>   block_type * steal()
00105   {
00106     assert(size() &gt; 0);
00107     <span class="keywordflow">if</span>(free_blocks_size)
00108     {
00109       STXXL_VERBOSE1(<span class="stringliteral">"write_pool::steal : "</span>&lt;&lt;free_blocks_size&lt;&lt;<span class="stringliteral">" free blocks available"</span>)
00110       --free_blocks_size;
00111       block_type * p = free_blocks.back();
00112       free_blocks.pop_back();
00113       <span class="keywordflow">return</span> p;
00114     }
00115     STXXL_VERBOSE1(<span class="stringliteral">"write_pool::steal : all "</span>&lt;&lt;busy_blocks_size&lt;&lt;<span class="stringliteral">" are busy"</span>)
00116     busy_blocks_iterator completed = <a class="code" href="group__iolayer.html#a2">wait_any</a>(busy_blocks.begin(),busy_blocks.end());
00117     assert(completed != busy_blocks.end()); <span class="comment">// we got something reasonable from wait_any</span>
00118     assert(completed-&gt;req-&gt;poll()); <span class="comment">// and it is *really* completed</span>
00119     block_type * p = completed-&gt;block;
00120     busy_blocks.erase(completed);
00121     --busy_blocks_size;
00122     check_all_busy(); <span class="comment">// for debug</span>
00123     <span class="keywordflow">return</span> p;
00124   }
00125   
00126   <span class="comment">// depricated name for the steal()</span>
00127   block_type * get()
00128   {
00129     <span class="keywordflow">return</span> steal();
00130   }
00131   
<a name="l00134"></a><a class="code" href="classstxxl_1_1write__pool.html#a6">00134</a>   <span class="keywordtype">void</span> resize(<span class="keywordtype">unsigned</span> new_size)
00135   {
00136     <span class="keywordtype">int</span> diff = int(new_size) - int(size());
00137     <span class="keywordflow">if</span>(diff &gt; 0 )
00138     {
00139       free_blocks_size += diff;
00140       <span class="keywordflow">while</span>(--diff &gt;= 0)
00141         free_blocks.push_back(<span class="keyword">new</span> block_type);
00142       
00143       <span class="keywordflow">return</span>;
00144     }
00145     
00146     <span class="keywordflow">while</span>(++diff &lt;= 0)
00147       <span class="keyword">delete</span> get();
00148   }
00149   
00150   <a class="code" href="classstxxl_1_1request__ptr.html">request_ptr</a> get_request(bid_type bid)
00151   {
00152     busy_blocks_iterator i2 = busy_blocks.begin();
00153     <span class="keywordflow">for</span>(;i2 != busy_blocks.end();++i2)
00154     {
00155       <span class="keywordflow">if</span>(i2-&gt;bid == bid)
00156         <span class="keywordflow">return</span> i2-&gt;req;
00157     }
00158     <span class="keywordflow">return</span> request_ptr();
00159   }
00160   
00161   
00162   block_type * steal(bid_type bid)
00163   {
00164     busy_blocks_iterator i2 = busy_blocks.begin();
00165     <span class="keywordflow">for</span>(;i2 != busy_blocks.end();++i2)
00166     {
00167       <span class="keywordflow">if</span>(i2-&gt;bid == bid)
00168       {
00169         block_type * p = i2-&gt;block;
00170         i2-&gt;req-&gt;wait();
00171         busy_blocks.erase(i2);
00172         --busy_blocks_size;
00173         <span class="keywordflow">return</span> p;
00174       }
00175     }
00176     <span class="keywordflow">return</span> NULL;
00177   }
00178   
00179   <span class="keywordtype">void</span>  add(block_type * block)
00180   {
00181     free_blocks.push_back(block);
00182     ++free_blocks_size;
00183   }
00184 <span class="keyword">protected</span>:
00185   <span class="keywordtype">void</span> check_all_busy()
00186   {
00187     busy_blocks_iterator cur = busy_blocks.begin();
00188     <span class="keywordtype">int</span> cnt = 0,busy_blocks_size_old = busy_blocks_size;
00189     <span class="keywordflow">for</span>(;cur!=busy_blocks.end();++cur)
00190     {
00191       <span class="keywordflow">if</span>(cur-&gt;req-&gt;poll())
00192       {
00193         free_blocks.push_back(cur-&gt;block);
00194         busy_blocks.erase(cur);
00195         cur = busy_blocks.begin();
00196         ++cnt;
00197         --busy_blocks_size;
00198         ++free_blocks_size;
00199       }
00200     }
00201     STXXL_VERBOSE1(<span class="stringliteral">"write_pool::check_all_busy : "</span>&lt;&lt;cnt&lt;&lt;
00202       <span class="stringliteral">" are completed out of "</span>&lt;&lt;busy_blocks_size_old&lt;&lt;<span class="stringliteral">" busy blocks"</span>)
00203   }
00204 };
00205  
00207 
00208 __STXXL_END_NAMESPACE
00209  
00210 <span class="preprocessor"> #endif</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Fri Nov 21 15:28:12 2003 for <stxxl> by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.4 </small></address>
</body>
</html>
