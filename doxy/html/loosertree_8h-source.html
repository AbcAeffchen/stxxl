<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>loosertree.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc1 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="modules.html">Modules</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; <a class="qindex" href="examples.html">Examples</a> &nbsp; </center>
<hr><h1>loosertree.h</h1><div class="fragment"><pre>00001 <span class="preprocessor">#ifndef LOOSERTREE_HEADER</span>
00002 <span class="preprocessor"></span><span class="preprocessor">#define LOOSERTREE_HEADER</span>
00003 <span class="preprocessor"></span>
00004 <span class="comment">/***************************************************************************</span>
00005 <span class="comment"> *            loosertree.h</span>
00006 <span class="comment"> *</span>
00007 <span class="comment"> *  Sat Aug 24 23:52:58 2002</span>
00008 <span class="comment"> *  Copyright  2002  Roman Dementiev, Peter Sanders</span>
00009 <span class="comment"> *  dementiev@mpi-sb.mpg.de</span>
00010 <span class="comment"> ****************************************************************************/</span>
00011 <span class="preprocessor">#include "../common/utils.h"</span>
00012 
00013 __STXXL_BEGIN_NAMESPACE
00014 
00015 <span class="keyword">template</span> &lt;<span class="keyword">typename</span> run_cursor_type, 
00016                                         <span class="keyword">typename</span> run_cursor_cmp_type,
00017                                         <span class="keywordtype">unsigned</span> buffer_size&gt;
00018 <span class="keyword">class </span>looser_tree
00019 {
00020         looser_tree ()
00021         {
00022         };
00023         <span class="keywordtype">int</span> logK;
00024         <span class="keywordtype">int</span> k;
00025 
00026         <span class="keywordtype">int</span> *entry;
00027         run_cursor_type *current;
00028         run_cursor_cmp_type cmp;
00029         <span class="keywordtype">int</span> init_winner (<span class="keywordtype">int</span> root)
00030         {
00031                 <span class="keywordflow">if</span> (root &gt;= k)
00032                 {
00033                         <span class="keywordflow">return</span> root - k;
00034                 }
00035                 <span class="keywordflow">else</span>
00036                 {
00037                         <span class="keywordtype">int</span> left = init_winner (2 * root);
00038                         <span class="keywordtype">int</span> right = init_winner (2 * root + 1);
00039                         <span class="keywordflow">if</span> (cmp (current[left], current[right]))
00040                         {
00041                                 entry[root] = right;
00042                                 <span class="keywordflow">return</span> left;
00043                         }
00044                         <span class="keywordflow">else</span>
00045                         {
00046                                 entry[root] = left;
00047                                 <span class="keywordflow">return</span> right;
00048                         }
00049                 }
00050         };
00051 <span class="keyword">public</span>:
00052         <span class="keyword">typedef</span> <span class="keyword">typename</span> run_cursor_type::prefetcher_type prefetcher_type;
00053         <span class="keyword">typedef</span> <span class="keyword">typename</span> run_cursor_type::value_type value_type;
00054         
00055         looser_tree (
00056                 prefetcher_type * p, 
00057                 <span class="keywordtype">int</span> nruns, 
00058                 run_cursor_cmp_type c): cmp(c)
00059         {
00060                 run_cursor_type::prefetcher() = p;
00061                 <span class="keywordtype">int</span> i;
00062                 logK = static_cast &lt; int &gt;(ceil (log (nruns) / log (2.)));      <span class="comment">// replace with something smart</span>
00063                 <span class="keywordtype">int</span> kReg = k = (1 &lt;&lt; logK);
00064                 current = <span class="keyword">new</span> run_cursor_type[kReg];
00065                 entry = <span class="keyword">new</span> <span class="keywordtype">int</span>[(kReg &lt;&lt; 1)];
00066                 <span class="comment">// init cursors</span>
00067                 <span class="keywordflow">for</span> (i = 0; i &lt; nruns; i++)
00068                 {
00069                         current[i].buffer = p-&gt;pull_block();
00070                         current[i].pos = 0;
00071                         entry[kReg + i] = i;
00072                 }
00073 
00074                 <span class="keywordflow">for</span> (i = nruns; i &lt; kReg; i++)
00075                 {
00076                         current[i].make_inf ();
00077                         entry[kReg + i] = i;
00078                 }
00079 
00080                 entry[0] = init_winner (1);
00081 
00082         }
00083         ~looser_tree()
00084         {
00085                 <span class="keyword">delete</span> [] current;
00086                 <span class="keyword">delete</span> [] entry;
00087         }
00088 
00089 <span class="keyword">private</span>:
00090         <span class="keyword">template</span> &lt; <span class="keywordtype">unsigned</span> LogK &gt; <span class="keywordtype">void</span> multi_merge_unrolled (value_type * to)
00091         {
00092                 run_cursor_type *currentE, *winnerE;
00093                 <span class="keywordtype">int</span> *regEntry = entry;
00094                 value_type *done = to + buffer_size;
00095                 <span class="keywordtype">int</span> winnerIndex = entry[0];
00096 
00097                 <span class="keywordflow">while</span> (LIKELY (to &lt; done))
00098                 {
00099                         winnerE = current + winnerIndex;
00100                         *(to++) = winnerE-&gt;current ();
00101 
00102                         (*winnerE)++;
00103 
00104 
00105 <span class="preprocessor">#define TreeStep(L)                                                                                                                                                                                                                                                                         \</span>
00106 <span class="preprocessor">      if (LogK &gt;= L )                                                                                                                                                                                                                                                               \</span>
00107 <span class="preprocessor">      {                                                                                                                                                                                                                                                                                                                     \</span>
00108 <span class="preprocessor">                                currentE = current +                                                            \</span>
00109 <span class="preprocessor">          regEntry[ (winnerIndex+(1&lt;&lt;LogK)) &gt;&gt; (((int(LogK-L)+1)&gt;=0)?((LogK-L)+1):0) ];\</span>
00110 <span class="preprocessor">                                if( cmp(*currentE,*winnerE) )                                                                                                                                                                                               \</span>
00111 <span class="preprocessor">                                {                                                                                                                                                                                                                                                                                                                   \</span>
00112 <span class="preprocessor">                                        swap(regEntry[(winnerIndex+(1&lt;&lt;LogK))                                         \</span>
00113 <span class="preprocessor">            &gt;&gt; (((int(LogK-L)+1)&gt;=0)?((LogK-L)+1):0) ],winnerIndex);                      \</span>
00114 <span class="preprocessor">                                        winnerE = currentE;                                                                                                                                                                                                                                 \</span>
00115 <span class="preprocessor">                                }                                                                                                                                                                                                                                                                                                                   \</span>
00116 <span class="preprocessor">      }</span>
00117 <span class="preprocessor"></span>
00118                         TreeStep (10);
00119                         TreeStep (9);
00120                         TreeStep (8);
00121                         TreeStep (7);
00122                         TreeStep (6);
00123                         TreeStep (5);
00124                         TreeStep (4);
00125                         TreeStep (3);
00126                         TreeStep (2);
00127                         TreeStep (1);
00128 
00129 <span class="preprocessor">#undef TreeStep</span>
00130 <span class="preprocessor"></span>
00131                 }
00132 
00133                 regEntry[0] = winnerIndex;
00134                 
00135         };
00136 
00137         <span class="keywordtype">void</span> multi_merge_k (value_type * to)
00138         {
00139                 run_cursor_type *currentE, *winnerE;
00140                 <span class="keywordtype">int</span> kReg = k;
00141                 value_type *done = to + buffer_size;
00142                 <span class="keywordtype">int</span> winnerIndex = entry[0];
00143 
00144                 <span class="keywordflow">while</span> (LIKELY (to &lt; done))
00145                 {
00146                         winnerE = current + winnerIndex;
00147                         *(to++) = winnerE-&gt;current ();
00148 
00149                         (*winnerE)++;
00150 
00151                         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = (winnerIndex + kReg) &gt;&gt; 1; i &gt; 0;i &gt;&gt;= 1)
00152                         {
00153                                 currentE = current + entry[i];
00154 
00155                                 <span class="keywordflow">if</span> (cmp (*currentE, *winnerE))
00156                                 {
00157                                         swap (entry[i], winnerIndex);
00158                                         winnerE = currentE;
00159                                 }
00160                         }
00161                 }
00162 
00163                 entry[0] = winnerIndex;
00164         };
00165 
00166 <span class="keyword">public</span>:
00167         <span class="keywordtype">void</span> multi_merge (value_type * to)
00168         {
00169                 <span class="keywordflow">switch</span> (logK)
00170                 {
00171                 <span class="keywordflow">case</span> 2:
00172                         multi_merge_unrolled &lt; 2 &gt; (to);
00173                         <span class="keywordflow">break</span>;
00174                 <span class="keywordflow">case</span> 3:
00175                         multi_merge_unrolled &lt; 3 &gt; (to);
00176                         <span class="keywordflow">break</span>;
00177                 <span class="keywordflow">case</span> 4:
00178                         multi_merge_unrolled &lt; 4 &gt; (to);
00179                         <span class="keywordflow">break</span>;
00180                 <span class="keywordflow">case</span> 5:
00181                         multi_merge_unrolled &lt; 5 &gt; (to);
00182                         <span class="keywordflow">break</span>;
00183                 <span class="keywordflow">case</span> 6:
00184                         multi_merge_unrolled &lt; 6 &gt; (to);
00185                         <span class="keywordflow">break</span>;
00186                 <span class="keywordflow">case</span> 7:
00187                         multi_merge_unrolled &lt; 7 &gt; (to);
00188                         <span class="keywordflow">break</span>;
00189                 <span class="keywordflow">case</span> 8:
00190                         multi_merge_unrolled &lt; 8 &gt; (to);
00191                         <span class="keywordflow">break</span>;
00192                 <span class="keywordflow">case</span> 9:
00193                         multi_merge_unrolled &lt; 9 &gt; (to);
00194                         <span class="keywordflow">break</span>;
00195                 <span class="keywordflow">case</span> 10:
00196                         multi_merge_unrolled &lt; 10 &gt; (to);
00197                         <span class="keywordflow">break</span>;
00198                 <span class="keywordflow">default</span>:
00199                         multi_merge_k (to);
00200                         <span class="keywordflow">break</span>;
00201                 }
00202                 
00203         }
00204 
00205 };
00206 
00207 __STXXL_END_NAMESPACE
00208 
00209 <span class="preprocessor">#endif</span>
</pre></div><hr><address style="align: right;"><small>Generated on Tue Jul 1 11:08:35 2003 for &lt;stxxl&gt; by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc1 </small></address>
</body>
</html>
