<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>mmap_file.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc1 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="modules.html">Modules</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; <a class="qindex" href="examples.html">Examples</a> &nbsp; </center>
<hr><h1>mmap_file.h</h1><div class="fragment"><pre>00001 <span class="preprocessor">#ifndef MMAP_HEADER</span>
00002 <span class="preprocessor"></span><span class="preprocessor">#define MMAP_HEADER</span>
00003 <span class="preprocessor"></span>
00004 <span class="comment">/***************************************************************************</span>
00005 <span class="comment"> *            mmap_file.h</span>
00006 <span class="comment"> *</span>
00007 <span class="comment"> *  Sat Aug 24 23:54:54 2002</span>
00008 <span class="comment"> *  Copyright  2002  Roman Dementiev</span>
00009 <span class="comment"> *  dementiev@mpi-sb.mpg.de</span>
00010 <span class="comment"> ****************************************************************************/</span>
00011 
00012 <span class="preprocessor">#include "ufs_file.h"</span>
00013 <span class="preprocessor">#include &lt;sys/mman.h&gt;</span>
00014 
00015 __STXXL_BEGIN_NAMESPACE
00016 
00022 
00024         <span class="keyword">class </span>mmap_file:<span class="keyword">public</span> ufs_file_base
00025         {
00026                 
00027         <span class="keyword">public</span>:
00032                 mmap_file (<span class="keyword">const</span> std::string &amp; filename, <span class="keywordtype">int</span> mode, <span class="keywordtype">int</span> disk = -1):
00033                         ufs_file_base (filename, mode, disk)
00034                 {
00035                 };
00036                 request_ptr aread(
00037                                 <span class="keywordtype">void</span> *buffer, 
00038                                 off_t pos, 
00039                                 size_t bytes,
00040                                 completion_handler on_cmpl);
00041                 request_ptr awrite(
00042                                 <span class="keywordtype">void</span> *buffer,
00043                                 off_t pos,
00044                                 size_t bytes,
00045                                 completion_handler on_cmpl);
00046         };
00047         
00049         <span class="keyword">class </span>mmap_request:<span class="keyword">public</span> ufs_request_base
00050         {
00051                 <span class="keyword">friend</span> <span class="keyword">class </span>mmap_file;
00052           <span class="keyword">protected</span>:
00053                   mmap_request (mmap_file * f,
00054                                 <span class="keywordtype">void</span> *buf, off_t off, size_t b,
00055                                 request_type t,
00056                                 completion_handler on_cmpl):
00057                                 ufs_request_base (f, buf, off, b, t, on_cmpl)
00058                 {
00059                 };
00060                 <span class="keywordtype">void</span> serve();
00061                 
<a name="l00062"></a><a class="code" href="classstxxl_1_1mmap__request.html#a0">00062</a>         <span class="keyword">public</span>:
00063                 <span class="keyword">const</span> <span class="keywordtype">char</span> *io_type()
00064                 {
00065                         <span class="keywordflow">return</span> <span class="stringliteral">"mmap"</span>;
00066                 };
00067   <span class="keyword">private</span>:
00068     <span class="comment">// Following methods are declared but not implemented </span>
00069     <span class="comment">// intentionnaly to forbid their usage</span>
00070                 mmap_request(<span class="keyword">const</span> mmap_request &amp;);
00071     mmap_request &amp; operator=(<span class="keyword">const</span> mmap_request &amp;);
00072                 mmap_request();
00073         };
00074 
00075         <span class="keywordtype">void</span> mmap_request::serve()
00076         {
00077                 <span class="comment">// file-&gt;set_size(offset+bytes);</span>
00078                 <span class="keywordtype">void</span> *mem = mmap (NULL, bytes, PROT_READ | PROT_WRITE, MAP_SHARED, file-&gt;get_file_des (), offset);
00079                 <span class="keywordflow">if</span> (mem == MAP_FAILED)
00080                 {
00081                         STXXL_ERRMSG(<span class="stringliteral">"Mapping failed."</span>)
00082                         STXXL_ERRMSG(<span class="stringliteral">"Page size: "</span> &lt;&lt; sysconf (_SC_PAGESIZE) &lt;&lt; <span class="stringliteral">" offset modulo page size"</span> &lt;&lt; 
00083                                 (offset % sysconf(_SC_PAGESIZE)))
00084                         abort ();
00085                 }
00086                 <span class="keywordflow">else</span> 
00087                 <span class="keywordflow">if</span> (mem == 0)
00088                 { 
00089                         stxxl_function_error
00090                 }
00091                 <span class="keywordflow">else</span>
00092                 {
00093                         <span class="keywordflow">if</span> (type == READ)
00094                         {
00095                                 stxxl_ifcheck (memcpy (buffer, mem, bytes))
00096                                 <span class="keywordflow">else</span>
00097                                 stxxl_ifcheck (munmap ((<span class="keywordtype">char</span> *) mem, bytes))}
00098                                 <span class="keywordflow">else</span>
00099                                 {
00100                                         stxxl_ifcheck (memcpy (mem, buffer, bytes))
00101                                         <span class="keywordflow">else</span>
00102                                         stxxl_ifcheck (munmap ((<span class="keywordtype">char</span> *) mem, bytes))
00103                                 }
00104                 }
00105 
00106                 _state.set_to (DONE);
00107 
00108                 waiters_mutex.lock ();
00109                 
00110                 <span class="comment">// &lt;&lt; notification &gt;&gt;</span>
00111                 <a class="code" href="group__stlalgo.html#a10">std::for_each</a>(
00112                         waiters.begin (),
00113                         waiters.end(),
00114                         std::mem_fun(&amp;onoff_switch::on) );
00115                 
00116                 waiters_mutex.unlock ();
00117 
00118                 completed();
00119                 _state.set_to(READY2DIE);
00120         }
<a name="l00121"></a><a class="code" href="classstxxl_1_1mmap__file.html#a2">00121</a> 
00122         <a class="code" href="classstxxl_1_1request__ptr.html">request_ptr</a> mmap_file::aread(
00123                         <span class="keywordtype">void</span> *buffer, 
00124                         off_t pos, 
00125                         size_t bytes,
00126                         <a class="code" href="classstxxl_1_1completion__handler.html">completion_handler</a> on_cmpl)
00127         {
00128                 <a class="code" href="classstxxl_1_1request__ptr.html">request_ptr</a> req = <span class="keyword">new</span> <a class="code" href="classstxxl_1_1mmap__request.html">mmap_request</a> (
00129                                         <span class="keyword">this</span>, 
00130                                         buffer, 
00131                                         pos, 
00132                                         bytes,
00133                                         request::READ, 
00134                                         on_cmpl);
00135                 
00136                 <span class="keywordflow">if</span> (!req.<a class="code" href="classstxxl_1_1request__ptr.html#a7">get</a>())
00137                         stxxl_function_error;
00138                 
00139 <span class="preprocessor">                #ifndef NO_OVERLAPPING</span>
00140 <span class="preprocessor"></span>                disk_queues::get_instance ()-&gt;add_readreq(req,<a class="code" href="classstxxl_1_1file.html#a5">get_id</a>());
00141 <span class="preprocessor">                #endif</span>
00142 <span class="preprocessor"></span>    
00143     <span class="keywordflow">return</span> req;
<a name="l00144"></a><a class="code" href="classstxxl_1_1mmap__file.html#a3">00144</a>         };
00145         request_ptr mmap_file::awrite (
00146                         <span class="keywordtype">void</span> *buffer, 
00147                         off_t pos, 
00148                         size_t bytes,
00149                         completion_handler on_cmpl)
00150         {
00151                 request_ptr req = <span class="keyword">new</span> mmap_request(
00152                                 <span class="keyword">this</span>, 
00153                                 buffer, 
00154                                 pos, 
00155                                 bytes,
00156                                 request::WRITE, 
00157                                 on_cmpl);
00158                 
00159                 <span class="keywordflow">if</span> (!req.get())
00160                         stxxl_function_error;
00161                 
00162 <span class="preprocessor">                #ifndef NO_OVERLAPPING</span>
00163 <span class="preprocessor"></span>                disk_queues::get_instance ()-&gt;add_writereq(req,<a class="code" href="classstxxl_1_1file.html#a5">get_id</a>());
00164 <span class="preprocessor">                #endif</span>
00165 <span class="preprocessor"></span>    
00166     <span class="keywordflow">return</span> req;
00167         };
00168 
00170   
00171 __STXXL_END_NAMESPACE
00172 
00173 <span class="preprocessor">#endif</span>
</pre></div><hr><address style="align: right;"><small>Generated on Tue Jul 1 11:08:35 2003 for &lt;stxxl&gt; by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc1 </small></address>
</body>
</html>
