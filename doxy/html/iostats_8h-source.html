<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>iostats.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc1 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="modules.html">Modules</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; <a class="qindex" href="examples.html">Examples</a> &nbsp; </center>
<hr><h1>iostats.h</h1><div class="fragment"><pre>00001 <span class="preprocessor">#ifndef IOSTATS_HEADER</span>
00002 <span class="preprocessor"></span><span class="preprocessor">#define IOSTATS_HEADER</span>
00003 <span class="preprocessor"></span>
00004 <span class="comment">/***************************************************************************</span>
00005 <span class="comment"> *            iostats.h</span>
00006 <span class="comment"> *</span>
00007 <span class="comment"> *  Sat Aug 24 23:54:50 2002</span>
00008 <span class="comment"> *  Copyright  2002  Roman Dementiev</span>
00009 <span class="comment"> *  dementiev@mpi-sb.mpg.de</span>
00010 <span class="comment"> ****************************************************************************/</span>
00011 
00012 <span class="preprocessor">#include "../common/mutex.h"</span>
00013 <span class="preprocessor">#include "../common/utils.h"</span>
00014 
00015 <span class="preprocessor">#include &lt;iostream&gt;</span>
00016 
00017 __STXXL_BEGIN_NAMESPACE
00018 
00022 
00023 <span class="preprocessor">#ifdef COUNT_WAIT_TIME</span>
00024 <span class="preprocessor"></span><span class="keyword">extern</span> <span class="keywordtype">double</span> stxxl::wait_time_counter;
00025 <span class="preprocessor">#endif</span>
00026 <span class="preprocessor"></span>
00027         <span class="keyword">class </span>disk_queue;
00028 
00031         <span class="keyword">class </span>stats
00032         {
00033                 <span class="keyword">friend</span> <span class="keyword">class </span>disk_queue;
00034                 <span class="keywordtype">unsigned</span> reads, writes; <span class="comment">// number of operations</span>
00035                 <span class="keywordtype">double</span> t_reads, t_writes;       <span class="comment">//  seconds spent in operations</span>
00036                 <span class="keywordtype">double</span> p_reads, p_writes;       <span class="comment">// seconds spent in parallel operations</span>
00037                 <span class="keywordtype">double</span> p_begin_read, p_begin_write;     <span class="comment">// start time of parallel operation</span>
00038                 <span class="keywordtype">double</span> p_ios;   <span class="comment">// seconds spent in all parallel I/O operations (read and write)</span>
00039                 <span class="keywordtype">double</span> p_begin_io;
00040                 <span class="keywordtype">int</span> acc_ios;
00041                 <span class="keywordtype">int</span> acc_reads, acc_writes;      <span class="comment">// number of requests, participating in parallel operation</span>
00042                 mutex read_mutex, write_mutex, io_mutex;
00043                 <span class="keyword">static</span> stats *instance;
00044                   stats ():reads (0),
00045                         writes (0),
00046                         t_reads (0.0),
00047                         t_writes (0.0),
00048                         p_reads (0.0),
00049                         p_writes (0.0),
00050                         p_begin_read (0.0),
00051                         p_begin_write (0.0),
00052                         p_ios (0.0),
00053                         p_begin_io (0),
00054                         acc_ios (0), acc_reads (0), acc_writes (0)
00055                 {
00056                 };
00057         <span class="keyword">public</span>:
00060                 <span class="keyword">static</span> stats *get_instance ()
00061                 {
00062                         <span class="keywordflow">if</span> (!instance)
00063                                 instance = <span class="keyword">new</span> stats ();
00064                         <span class="keywordflow">return</span> instance;
00065                 };
00068                 <span class="keywordtype">unsigned</span> get_reads ()
00069                 {
00070                         <span class="keywordflow">return</span> reads;
00071                 };
00074                 <span class="keywordtype">unsigned</span> get_writes ()
00075                 {
00076                         <span class="keywordflow">return</span> writes;
00077                 };
00082                 <span class="keywordtype">double</span> get_read_time ()
00083                 {
00084                         <span class="keywordflow">return</span> t_reads;
00085                 };
00090                 <span class="keywordtype">double</span> get_write_time ()
00091                 {
00092                         <span class="keywordflow">return</span> t_writes;
00093                 };
00098                 <span class="keywordtype">double</span> get_pread_time()
00099                 {
00100                         <span class="keywordflow">return</span> p_reads;
00101                 };
00106                 <span class="keywordtype">double</span> get_pwrite_time()
00107                 {
00108                         <span class="keywordflow">return</span> p_writes;
00109                 };
00114                 <span class="keywordtype">double</span> get_pio_time()
00115                 {
00116                         <span class="keywordflow">return</span> p_ios;
00117                 };
00119                 <span class="keywordtype">void</span> reset()
00120                 {
00121                         read_mutex.lock ();
00122                         <span class="comment">//      assert(acc_reads == 0);</span>
00123                         <span class="keywordflow">if</span> (acc_reads)
00124                                 std::cerr &lt;&lt; <span class="stringliteral">"Warning: "</span> &lt;&lt; acc_reads &lt;&lt;
00125                                         <span class="stringliteral">" read(s) not yet finished"</span> &lt;&lt; std::
00126                                         endl;
00127 
00128                         reads = 0;
00129                         t_reads = 0;
00130                         p_reads = 0.0;
00131                         read_mutex.unlock ();
00132                         write_mutex.lock ();
00133                         <span class="comment">//      assert(acc_writes == 0);</span>
00134                         <span class="keywordflow">if</span> (acc_writes)
00135                                 std::cerr &lt;&lt; <span class="stringliteral">"Warning: "</span> &lt;&lt; acc_writes &lt;&lt;
00136                                         <span class="stringliteral">" write(s) not yet finished"</span> &lt;&lt; std::
00137                                         endl;
00138 
00139                         writes = 0;
00140                         t_writes = 0.0;
00141                         p_writes = 0.0;
00142                         write_mutex.unlock ();
00143 
00144                         io_mutex.lock ();
00145                         <span class="comment">//      assert(acc_ios == 0);</span>
00146                         <span class="keywordflow">if</span> (acc_ios)
00147                                 std::cerr &lt;&lt; <span class="stringliteral">"Warning: "</span> &lt;&lt; acc_ios &lt;&lt;
00148                                         <span class="stringliteral">" io(s) not yet finished"</span> &lt;&lt; std::
00149                                         endl;
00150 
00151                         p_ios = 0.0;
00152                         io_mutex.unlock ();
00153 
00154                 };
00155                 
00156                 
00157 <span class="preprocessor">#ifdef COUNT_WAIT_TIME</span>
00158 <span class="preprocessor"></span>
00159                 <span class="keywordtype">void</span> _reset_io_wait_time() { stxxl::wait_time_counter = 0.0; }
00165                 <span class="keywordtype">double</span> get_io_wait_time() { <span class="keywordflow">return</span> (stxxl::wait_time_counter); }
00169                 <span class="keywordtype">double</span> increment_io_wait_time(<span class="keywordtype">double</span> val) { <span class="keywordflow">return</span> stxxl::wait_time_counter+= val; }
00170 <span class="preprocessor">#else</span>
<a name="l00171"></a><a class="code" href="classstxxl_1_1stats.html#a8">00171</a> <span class="preprocessor"></span>
00172                 <span class="keywordtype">void</span> _reset_io_wait_time() {}
00179                 <span class="keywordtype">double</span> get_io_wait_time() { <span class="keywordflow">return</span> -1.0; }
00183                 <span class="keywordtype">double</span> increment_io_wait_time(<span class="keywordtype">double</span> val) { <span class="keywordflow">return</span> -1.0; }
00184 <span class="preprocessor">#endif</span>
00185 <span class="preprocessor"></span>                
00186         <span class="keyword">protected</span>:
00187                 <span class="keywordtype">void</span> write_started ()
00188                 {
00189                         write_mutex.lock ();
00190                         <span class="keywordtype">double</span> now = stxxl_timestamp ();
00191                         writes++;
00192                         <span class="keywordtype">double</span> diff = now - p_begin_write;
00193                         t_writes += double (acc_writes) * diff;
00194                         p_begin_write = now;
00195                         p_writes += (acc_writes++) ? diff : 0.0;
00196                         write_mutex.unlock ();
00197 
00198                         io_mutex.lock ();
00199                         diff = now - p_begin_io;
00200                         p_ios += (acc_ios++) ? diff : 0.0;
00201                         p_begin_io = now;
00202                         io_mutex.unlock ();
00203                 }
00204                 <span class="keywordtype">void</span> write_finished ()
00205                 {
00206                         write_mutex.lock ();
00207                         <span class="keywordtype">double</span> now = stxxl_timestamp ();
00208                         <span class="keywordtype">double</span> diff = now - p_begin_write;
00209                         t_writes += double (acc_writes) * diff;
00210                         p_begin_write = now;
00211                         p_writes += (acc_writes--) ? diff : 0.0;
00212                         write_mutex.unlock ();
00213 
00214                         io_mutex.lock ();
00215                         diff = now - p_begin_io;
00216                         p_ios += (acc_ios--) ? diff : 0.0;
00217                         p_begin_io = now;
00218                         io_mutex.unlock ();
00219                 }
00220                 <span class="keywordtype">void</span> read_started ()
00221                 {
00222                         read_mutex.lock ();
00223                         <span class="keywordtype">double</span> now = stxxl_timestamp ();
00224                         reads++;
00225                         <span class="keywordtype">double</span> diff = now - p_begin_read;
00226                         t_reads += double (acc_reads) * diff;
00227                         p_begin_read = now;
00228                         p_reads += (acc_reads++) ? diff : 0.0;
00229                         read_mutex.unlock ();
00230 
00231                         io_mutex.lock ();
00232                         diff = now - p_begin_io;
00233                         p_ios += (acc_ios++) ? diff : 0.0;
00234                         p_begin_io = now;
00235                         io_mutex.unlock ();
00236                 }
00237                 <span class="keywordtype">void</span> read_finished ()
00238                 {
00239                         read_mutex.lock ();
00240                         <span class="keywordtype">double</span> now = stxxl_timestamp ();
00241                         <span class="keywordtype">double</span> diff = now - p_begin_read;
00242                         t_reads += double (acc_reads) * diff;
00243                         p_begin_read = now;
00244                         p_reads += (acc_reads--) ? diff : 0.0;
00245                         read_mutex.unlock ();
00246 
00247                         io_mutex.lock ();
00248                         diff = now - p_begin_io;
00249                         p_ios += (acc_ios--) ? diff : 0.0;
00250                         p_begin_io = now;
00251                         io_mutex.unlock ();
00252                 }
00253         };
00254 
00256 
00257 __STXXL_END_NAMESPACE
00258 
00259 <span class="preprocessor">#endif</span>
</pre></div><hr><address style="align: right;"><small>Generated on Tue Jul 1 11:08:35 2003 for &lt;stxxl&gt; by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc1 </small></address>
</body>
</html>
