<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>iobase.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc1 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="modules.html">Modules</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="namespacemembers.html">Namespace Members</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; <a class="qindex" href="examples.html">Examples</a> &nbsp; </center>
<hr><h1>iobase.h</h1><div class="fragment"><pre>00001 <span class="preprocessor">#ifndef IOBASE_HEADER</span>
00002 <span class="preprocessor"></span><span class="preprocessor">#define IOBASE_HEADER</span>
00003 <span class="preprocessor"></span><span class="comment">/***************************************************************************</span>
00004 <span class="comment"> *            iobase.h</span>
00005 <span class="comment"> *</span>
00006 <span class="comment"> *  Sat Aug 24 23:54:44 2002</span>
00007 <span class="comment"> *  Copyright  2002  Roman Dementiev</span>
00008 <span class="comment"> *  dementiev@mpi-sb.mpg.de</span>
00009 <span class="comment"> ****************************************************************************/</span>
00010 
00011 
00012 <span class="preprocessor">#define STXXL_IO_STATS</span>
00013 <span class="preprocessor"></span>
00014 
00015 <span class="preprocessor">#if defined(__linux__)</span>
00016 <span class="preprocessor"></span><span class="preprocessor">#define STXXL_CHECK_BLOCK_ALIGNING</span>
00017 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00018 <span class="preprocessor"></span>
00019 <span class="comment">//#if defined(__linux__)</span>
00020 <span class="comment">//# if !defined(O_DIRECT) &amp;&amp; (defined(__alpha__) || defined(__i386__))</span>
00021 <span class="comment">//#  define O_DIRECT 040000 /* direct disk access */</span>
00022 <span class="comment">//# endif</span>
00023 <span class="comment">//#endif</span>
00024 
00025 
00026 <span class="comment">//#ifdef __sun__</span>
00027 <span class="comment">//#define O_DIRECT 0</span>
00028 <span class="comment">//#endif</span>
00029 
00030 
00031 <span class="preprocessor">#include &lt;iostream&gt;</span>
00032 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00033 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00034 <span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
00035 <span class="preprocessor">#include &lt;sys/time.h&gt;</span>
00036 <span class="preprocessor">#include &lt;fcntl.h&gt;</span>
00037 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
00038 <span class="preprocessor">#include &lt;pthread.h&gt;</span>
00039 <span class="preprocessor">#include &lt;string.h&gt;</span>
00040 <span class="preprocessor">#include &lt;errno.h&gt;</span>
00041 <span class="preprocessor">#include &lt;sys/resource.h&gt;</span>
00042 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00043 <span class="preprocessor">#include &lt;sys/wait.h&gt;</span>
00044 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00045 
00046 <span class="comment">// STL includes</span>
00047 <span class="preprocessor">#include &lt;algorithm&gt;</span>
00048 <span class="preprocessor">#include &lt;string&gt;</span>
00049 <span class="preprocessor">#include &lt;queue&gt;</span>
00050 <span class="preprocessor">#include &lt;map&gt;</span>
00051 <span class="preprocessor">#include &lt;set&gt;</span>
00052 
00053 
00054 <span class="preprocessor">#ifndef O_SYNC</span>
00055 <span class="preprocessor"></span><span class="preprocessor">#define O_SYNC 0</span>
00056 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00057 <span class="preprocessor"></span><span class="preprocessor">#ifndef O_RSYNC</span>
00058 <span class="preprocessor"></span><span class="preprocessor">#define O_RSYNC 0</span>
00059 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00060 <span class="preprocessor"></span><span class="preprocessor">#ifndef O_DSYNC</span>
00061 <span class="preprocessor"></span><span class="preprocessor">#define O_DSYNC 0</span>
00062 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00063 <span class="preprocessor"></span>
00064 
00065 <span class="preprocessor">#if defined(__linux__)</span>
00066 <span class="preprocessor"></span><span class="comment">//# include &lt;asm/fcntl.h&gt;</span>
00067 <span class="preprocessor"># if !defined(O_DIRECT) &amp;&amp; (defined(__alpha__) || defined(__i386__))</span>
00068 <span class="preprocessor"></span><span class="preprocessor">#  define O_DIRECT 040000       </span><span class="comment">/* direct disk access */</span>
00069 <span class="preprocessor"># endif</span>
00070 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00071 <span class="preprocessor"></span>
00072 
00073 <span class="preprocessor">#ifndef O_DIRECT</span>
00074 <span class="preprocessor"></span><span class="preprocessor">#define O_DIRECT O_SYNC</span>
00075 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00076 <span class="preprocessor"></span>
00077 
00078 <span class="preprocessor">#include "iostats.h"</span>
00079 <span class="preprocessor">#include "../common/utils.h"</span>
00080 <span class="preprocessor">#include "../common/semaphore.h"</span>
00081 <span class="preprocessor">#include "../common/mutex.h"</span>
00082 <span class="comment">//#include "../common/rwlock.h"</span>
00083 <span class="preprocessor">#include "../common/switch.h"</span>
00084 <span class="preprocessor">#include "../common/state.h"</span>
00085 <span class="preprocessor">#include "completion_handler.h"</span>
00086 
00087 __STXXL_BEGIN_NAMESPACE
00088 
00093 
00094 <span class="preprocessor">#define BLOCK_ALIGN 4096</span>
00095 <span class="preprocessor"></span>
00096         <span class="keyword">typedef</span> <span class="keywordtype">void</span> *(*thread_function_t) (<span class="keywordtype">void</span> *);
00097         <span class="keyword">typedef</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> DISKID;
00098 
00099         <span class="keyword">class </span>request;
00100   <span class="keyword">class </span>request_ptr;
00101         
<a name="l00103"></a><a class="code" href="structstxxl_1_1default__completion__handler.html">00103</a>         
00104         <span class="keyword">struct </span><a class="code" href="structstxxl_1_1default__completion__handler.html">default_completion_handler</a>
00105         {
00107                 <span class="keywordtype">void</span> operator() (<a class="code" href="classstxxl_1_1request.html">request</a> *) { };
00108         };
00109 
00111         
00114         <span class="keyword">class </span>file
00115         {
00118                 file ()
00119                 {
00120                 };
00121                 
00122         <span class="keyword">protected</span>:
00123                 <span class="keywordtype">int</span> id;
00124                 
00128                 file (<span class="keywordtype">int</span> _id):id (_id) { };
00129                 
00130         <span class="keyword">public</span>:
00132                 
00135                 <span class="keyword">enum</span> open_mode
00136                 { 
00137                                 RDONLY = 1, 
00138                                 WRONLY = 2, 
00139                                 RDWR = 4,   
00140                                 CREAT = 8,  
00141                                 DIRECT = 16,
00142                                 TRUNC = 32  
00143                 };
00144 
00151                 <span class="keyword">virtual</span> request_ptr aread (<span class="keywordtype">void</span> *buffer, off_t pos, size_t bytes,
00152                                     completion_handler on_cmpl ) = 0;
00159                 <span class="keyword">virtual</span> request_ptr awrite (<span class="keywordtype">void</span> *buffer, off_t pos, size_t bytes, 
00160             completion_handler on_cmpl ) = 0;
00161 
00164                 <span class="keyword">virtual</span> <span class="keywordtype">void</span> set_size (off_t newsize) = 0;
00167                 <span class="keyword">virtual</span> off_t size () = 0;
00169                 <span class="keywordtype">int</span> get_disk_number () 
00170                 {
00171                         <span class="keywordflow">return</span> id;
00172                 };
00176                 <span class="keywordtype">int</span> get_id()
00177                 {
00178                         <span class="keywordflow">return</span> id;
00179                 };
00180                 <span class="keyword">virtual</span> ~ file () { };
00181         };
00182 
00183         <span class="keyword">class </span>mc;
00184         <span class="keyword">class </span>disk_queue;
00185         <span class="keyword">class </span>disk_queues;
00186 
00188         
00192         <span class="keyword">class </span>request
00193         {
00194     <span class="keyword">friend</span> <span class="keywordtype">int</span> <a class="code" href="group__iolayer.html#a2">wait_any</a>(request_ptr req_array[], <span class="keywordtype">int</span> count);
00195                 <span class="keyword">friend</span> <span class="keyword">class </span>file;
00196                 <span class="keyword">friend</span> <span class="keyword">class </span>disk_queue;
00197                 <span class="keyword">friend</span> <span class="keyword">class </span>disk_queues;
00198     <span class="keyword">friend</span> <span class="keyword">class </span>request_ptr;
00199                 
00200         <span class="keyword">protected</span>:
00201                 <span class="keyword">virtual</span> <span class="keywordtype">bool</span> add_waiter (onoff_switch * sw) = 0;
00202                 <span class="keyword">virtual</span> <span class="keywordtype">void</span> delete_waiter (onoff_switch * sw) = 0;
00203                 <span class="comment">//virtual void enqueue () = 0;</span>
00204                 <span class="keyword">virtual</span> <span class="keywordtype">void</span> serve () = 0;
00205         
00206                 completion_handler on_complete;
00207                 <span class="keywordtype">int</span> ref_cnt;
00208     mutex ref_cnt_mutex;
00209     
00210                 <span class="keyword">enum</span> request_type { READ, WRITE };
00211                 
00212                 <span class="keywordtype">void</span> completed ()
00213                 {
00214                         on_complete(<span class="keyword">this</span>);
00215                 };
00216                 
00217         <span class="keyword">public</span>:
00218                 request(completion_handler on_compl):on_complete(on_compl),ref_cnt(0)
00219     {
00220       STXXL_VERBOSE3(<span class="stringliteral">"request "</span>&lt;&lt; <span class="keywordtype">unsigned</span>(<span class="keyword">this</span>) &lt;&lt;<span class="stringliteral">": creation, cnt: "</span>&lt;&lt;ref_cnt)
00221     }
00223                 <span class="keyword">virtual</span> <span class="keywordtype">void</span> wait () = 0;
00226                 <span class="keyword">virtual</span> <span class="keywordtype">bool</span> poll () = 0;
00229                 <span class="keyword">virtual</span> <span class="keyword">const</span> <span class="keywordtype">char</span> * io_type ()
00230                 {
00231                         <span class="keywordflow">return</span> <span class="stringliteral">"none"</span>;
00232                 };
00233                 <span class="keyword">virtual</span> ~request()
00234     {
00235         STXXL_VERBOSE3(<span class="stringliteral">"request "</span>&lt;&lt; <span class="keywordtype">unsigned</span>(<span class="keyword">this</span>) &lt;&lt;<span class="stringliteral">": deletion, cnt: "</span>&lt;&lt;ref_cnt)
00236     }
00237         <span class="keyword">private</span>:
00238     <span class="comment">// Following methods are declared but not implemented </span>
00239     <span class="comment">// intentionnaly to forbid their usage</span>
00240                 request(<span class="keyword">const</span> request &amp;);
00241     request &amp; operator=(<span class="keyword">const</span> request &amp;);
00242                 request();
00243     
00244     <span class="keywordtype">void</span> add_ref()
00245     {
00246       ref_cnt_mutex.lock();
00247       STXXL_VERBOSE3(<span class="stringliteral">"request "</span>&lt;&lt; <span class="keywordtype">unsigned</span>(<span class="keyword">this</span>) &lt;&lt;<span class="stringliteral">": adding reference, cnt: "</span>&lt;&lt;ref_cnt)
00248       ref_cnt++;
00249       ref_cnt_mutex.unlock();
00250     }
00251     <span class="keywordtype">bool</span> sub_ref()
00252     {
00253       ref_cnt_mutex.lock();
00254       STXXL_VERBOSE3(<span class="stringliteral">"request "</span>&lt;&lt; <span class="keywordtype">unsigned</span>(<span class="keyword">this</span>) &lt;&lt;<span class="stringliteral">": subtracting reference cnt: "</span>&lt;&lt;ref_cnt)
00255       <span class="keywordtype">int</span> val=--ref_cnt;
00256       ref_cnt_mutex.unlock();
00257       assert(val&gt;=0);
00258       <span class="keywordflow">return</span> (val==0);
00259     }
00260         };
00261 
00263   
00265   <span class="keyword">class </span>request_ptr
00266   {
00267     request * ptr;
00268     <span class="keywordtype">void</span> add_ref()
00269     {
00270       <span class="keywordflow">if</span>(ptr)
00271       {
00272         ptr-&gt;add_ref();
00273       }
00274     }
00275     <span class="keywordtype">void</span> sub_ref()
00276     {
00277       <span class="keywordflow">if</span>(ptr)
00278       {
00279         <span class="keywordflow">if</span>(ptr-&gt;sub_ref())
00280         {
00281           <span class="keyword">delete</span> ptr;
00282           ptr = NULL;
00283         }
00284       }
00285     }
00286   <span class="keyword">public</span>:
00288     request_ptr(request *ptr_=NULL):ptr(ptr_) { add_ref(); }
00290     request_ptr(<span class="keyword">const</span> request_ptr &amp; p): ptr(p.ptr) { add_ref(); }
00292     ~request_ptr() { sub_ref(); }
00295     request_ptr &amp; operator= (<span class="keyword">const</span> request_ptr &amp; p)
00296     {
00297       assert(p.ptr);
00298       <span class="keywordflow">return</span> (*<span class="keyword">this</span> = p.ptr);
00299     }
00302     request_ptr &amp; operator= (request * p)
00303     {
00304       <span class="keywordflow">if</span>(p != ptr)
00305       {
00306         sub_ref();
00307         ptr = p;
00308         add_ref();
00309       }
00310       <span class="keywordflow">return</span> *<span class="keyword">this</span>;
00311     }
00314     request &amp; operator * ()<span class="keyword"> const</span>
00315 <span class="keyword">    </span>{
00316       <span class="keywordflow">return</span> *ptr;
00317     }
00320     request * operator -&gt; ()<span class="keyword"> const</span>
00321 <span class="keyword">    </span>{
00322       <span class="keywordflow">return</span> ptr;
00323     }
00328     request * get() { <span class="keywordflow">return</span> ptr; }
00329   };
00330   
00332         
00337   <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="group__iolayer.html#a2">wait_any</a>(request_ptr req_array[], <span class="keywordtype">int</span> count);
00341   <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="group__iolayer.html#a3">wait_all</a>(request_ptr req_array[], <span class="keywordtype">int</span> count);
00347   <span class="keyword">inline</span> <span class="keywordtype">bool</span> <a class="code" href="group__iolayer.html#a4">poll_any</a> (request_ptr req_array[], <span class="keywordtype">int</span> count,<span class="keywordtype">int</span> &amp;index);
00348   
<a name="l00349"></a><a class="code" href="group__iolayer.html#a3">00349</a>   
00350   <span class="keywordtype">void</span> <a class="code" href="group__iolayer.html#a3">wait_all</a>(request_ptr req_array[], <span class="keywordtype">int</span> count)
00351         {
00352                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; count; i++)
00353                 {
00354                         req_array[i]-&gt;wait ();
00355                 }
00356         }
00357 
<a name="l00358"></a><a class="code" href="group__iolayer.html#a4">00358</a>   
00359         <span class="keywordtype">bool</span> <a class="code" href="group__iolayer.html#a4">poll_any</a> (request_ptr req_array[], <span class="keywordtype">int</span> count, <span class="keywordtype">int</span> &amp;index)
00360         {
00361                 index = -1;
00362                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; count; i++)
00363                 {
00364                         <span class="keywordflow">if</span> (req_array[i]-&gt;poll())
00365                         {
00366                                 index = i;
00367                                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
00368                         }
00369                 };
00370                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00371         }
<a name="l00372"></a><a class="code" href="group__iolayer.html#a2">00372</a> 
00373         <span class="keywordtype">int</span> <a class="code" href="group__iolayer.html#a2">wait_any</a> (request_ptr req_array[], <span class="keywordtype">int</span> count)
00374         {
00375                 START_COUNT_WAIT_TIME
00376                 onoff_switch sw;
00377                 <span class="keywordtype">int</span> i = 0, index = -1;
00378 
00379                 <span class="keywordflow">for</span> (; i &lt; count; i++)
00380                 {
00381                         <span class="keywordflow">if</span> (req_array[i]-&gt;add_waiter (&amp;sw))
00382                         {
00383                                 <span class="comment">// already done</span>
00384                                 index = i;
00385 
00386                                 <span class="keywordflow">while</span> (--i &gt;= 0)
00387                                         req_array[i]-&gt;delete_waiter (&amp;sw);
00388 
00389                                 END_COUNT_WAIT_TIME
00390                                 <span class="keywordflow">return</span> index;
00391                         }
00392                 }
00393 
00394                 sw.wait_for_on ();
00395 
00396                 <span class="keywordflow">for</span> (i = 0; i &lt; count; i++)
00397                 {
00398                         req_array[i]-&gt;delete_waiter (&amp;sw);
00399                         <span class="keywordflow">if</span> (index &lt; 0 &amp;&amp; req_array[i]-&gt;poll ())
00400                                 index = i;
00401                 }
00402 
00403                 END_COUNT_WAIT_TIME
00404                 <span class="keywordflow">return</span> index;
00405         }
00406 
00407         <span class="keyword">class </span>disk_queue
00408         {
00409         <span class="keyword">public</span>:
00410                 <span class="keyword">enum</span> priority_op { READ, WRITE, NONE };
00411         <span class="keyword">private</span>:
00412                 mutex write_mutex;
00413                 mutex read_mutex;
00414                 std::queue &lt; request_ptr &gt; write_queue;
00415                 std::queue &lt; request_ptr &gt; read_queue;
00416                 semaphore sem;
00417                 pthread_t thread;
00418                 priority_op _priority_op;
00419 
00420 <span class="preprocessor">#ifdef STXXL_IO_STATS</span>
00421 <span class="preprocessor"></span>                stats *iostats;
00422 <span class="preprocessor">#endif</span>
00423 <span class="preprocessor"></span>
00424                 <span class="keyword">static</span> <span class="keywordtype">void</span> *worker (<span class="keywordtype">void</span> *arg);
00425         <span class="keyword">public</span>:
00426                 disk_queue (<span class="keywordtype">int</span> n = 1); <span class="comment">// max number of requests simultainenously submitted to disk</span>
00427                 
00428                 <span class="keywordtype">void</span> set_priority_op (priority_op op)
00429                 {
00430                         _priority_op = op;
00431                 };
00432                 <span class="keywordtype">void</span> add_readreq (request_ptr &amp; req);
00433                 <span class="keywordtype">void</span> add_writereq (request_ptr &amp; req);
00434                 ~disk_queue ();
00435         };
00436 
00439         <span class="keyword">class </span>disk_queues
00440         {
00441         <span class="keyword">protected</span>:
00442                 std::map &lt; DISKID, disk_queue * &gt; queues;
00443                 disk_queues ()
00444                 {
00445                 };
00446         <span class="keyword">public</span>:
00447                 <span class="keywordtype">void</span> add_readreq (request_ptr &amp; req, DISKID disk)
00448                 {
00449                         <span class="keywordflow">if</span> (queues.find (disk) == queues.end ())
00450                         {
00451                                 <span class="comment">// create new disk queue</span>
00452                                 queues[disk] = <span class="keyword">new</span> disk_queue ();
00453                         }
00454                         queues[disk]-&gt;add_readreq (req);
00455                 };
00456                 <span class="keywordtype">void</span> add_writereq (request_ptr &amp; req, DISKID disk)
00457                 {
00458                         <span class="keywordflow">if</span> (queues.find (disk) == queues.end ())
00459                         {
00460                                 <span class="comment">// create new disk queue</span>
00461                                 queues[disk] = <span class="keyword">new</span> disk_queue ();
00462                         }
00463                         queues[disk]-&gt;add_writereq (req);
00464                 };
00465                 ~disk_queues ()
00466                 {
00467                         <span class="comment">// deallocate all queues</span>
00468                         <span class="keywordflow">for</span> (std::map &lt; DISKID, disk_queue * &gt;::iterator i =
00469                              queues.begin (); i != queues.end (); i++)
00470                                 <span class="keyword">delete</span> (*i).second;
00471                 };
00472                 <span class="keyword">static</span> disk_queues *get_instance ()
00473                 {
00474                         <span class="keywordflow">if</span> (!instance)
00475                                 instance = <span class="keyword">new</span> disk_queues ();
00476 
00477                         <span class="keywordflow">return</span> instance;
00478                 };
00484                 <span class="keywordtype">void</span> set_priority_op(disk_queue::priority_op op)
00485                 {
00486                         <span class="keywordflow">for</span> (std::map &lt; DISKID, disk_queue * &gt;::iterator i =
00487                              queues.begin (); i != queues.end (); i++)
00488                                 i-&gt;second-&gt;set_priority_op (op);
00489                 };
00490         <span class="keyword">private</span>:
00491                 <span class="keyword">static</span> disk_queues *instance;
00492         };
00493 
00494 <span class="preprocessor">#ifdef COUNT_WAIT_TIME</span>
00495 <span class="preprocessor"></span>        <span class="keyword">extern</span> <span class="keywordtype">double</span> wait_time_counter;
00496 <span class="preprocessor">#endif</span>
00497 <span class="preprocessor"></span>
00499   
00500 __STXXL_END_NAMESPACE
00501 
00502 
00503 <span class="preprocessor">#endif</span>
</pre></div><hr><address style="align: right;"><small>Generated on Tue Jul 1 11:08:35 2003 for &lt;stxxl&gt; by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc1 </small></address>
</body>
</html>
