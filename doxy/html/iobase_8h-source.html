<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>&lt;stxxl&gt;: iobase.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a> | <a class="qindex" href="examples.html">Examples</a></div>
<h1>iobase.h</h1><div class="fragment"><pre>00001 <span class="preprocessor">#ifndef IOBASE_HEADER</span>
00002 <span class="preprocessor"></span><span class="preprocessor">#define IOBASE_HEADER</span>
00003 <span class="preprocessor"></span><span class="comment">/***************************************************************************</span>
00004 <span class="comment"> *            iobase.h</span>
00005 <span class="comment"> *</span>
00006 <span class="comment"> *  Sat Aug 24 23:54:44 2002</span>
00007 <span class="comment"> *  Copyright  2002  Roman Dementiev</span>
00008 <span class="comment"> *  dementiev@mpi-sb.mpg.de</span>
00009 <span class="comment"> ****************************************************************************/</span>
00010 
00011 
00012 <span class="preprocessor">#define STXXL_IO_STATS</span>
00013 <span class="preprocessor"></span>
00014 
00015 <span class="preprocessor">#if defined(__linux__)</span>
00016 <span class="preprocessor"></span><span class="preprocessor">#define STXXL_CHECK_BLOCK_ALIGNING</span>
00017 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00018 <span class="preprocessor"></span>
00019 <span class="comment">//#if defined(__linux__)</span>
00020 <span class="comment">//# if !defined(O_DIRECT) &amp;&amp; (defined(__alpha__) || defined(__i386__))</span>
00021 <span class="comment">//#  define O_DIRECT 040000 /* direct disk access */</span>
00022 <span class="comment">//# endif</span>
00023 <span class="comment">//#endif</span>
00024 
00025 
00026 <span class="comment">//#ifdef __sun__</span>
00027 <span class="comment">//#define O_DIRECT 0</span>
00028 <span class="comment">//#endif</span>
00029 
00030 
00031 <span class="preprocessor">#include &lt;iostream&gt;</span>
00032 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00033 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00034 <span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
00035 <span class="preprocessor">#include &lt;sys/time.h&gt;</span>
00036 <span class="preprocessor">#include &lt;fcntl.h&gt;</span>
00037 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
00038 <span class="preprocessor">#include &lt;pthread.h&gt;</span>
00039 <span class="preprocessor">#include &lt;string.h&gt;</span>
00040 <span class="preprocessor">#include &lt;errno.h&gt;</span>
00041 <span class="preprocessor">#include &lt;sys/resource.h&gt;</span>
00042 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00043 <span class="preprocessor">#include &lt;sys/wait.h&gt;</span>
00044 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00045 
00046 <span class="comment">// STL includes</span>
00047 <span class="preprocessor">#include &lt;algorithm&gt;</span>
00048 <span class="preprocessor">#include &lt;string&gt;</span>
00049 <span class="preprocessor">#include &lt;queue&gt;</span>
00050 <span class="preprocessor">#include &lt;map&gt;</span>
00051 <span class="preprocessor">#include &lt;set&gt;</span>
00052 
00053 
00054 <span class="preprocessor">#ifndef O_SYNC</span>
00055 <span class="preprocessor"></span><span class="preprocessor">#define O_SYNC 0</span>
00056 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00057 <span class="preprocessor"></span><span class="preprocessor">#ifndef O_RSYNC</span>
00058 <span class="preprocessor"></span><span class="preprocessor">#define O_RSYNC 0</span>
00059 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00060 <span class="preprocessor"></span><span class="preprocessor">#ifndef O_DSYNC</span>
00061 <span class="preprocessor"></span><span class="preprocessor">#define O_DSYNC 0</span>
00062 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00063 <span class="preprocessor"></span>
00064 
00065 <span class="preprocessor">#if defined(__linux__)</span>
00066 <span class="preprocessor"></span><span class="comment">//# include &lt;asm/fcntl.h&gt;</span>
00067 <span class="preprocessor"># if !defined(O_DIRECT) &amp;&amp; (defined(__alpha__) || defined(__i386__))</span>
00068 <span class="preprocessor"></span><span class="preprocessor">#  define O_DIRECT 040000       </span><span class="comment">/* direct disk access */</span>
00069 <span class="preprocessor"># endif</span>
00070 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00071 <span class="preprocessor"></span>
00072 
00073 <span class="preprocessor">#ifndef O_DIRECT</span>
00074 <span class="preprocessor"></span><span class="preprocessor">#define O_DIRECT O_SYNC</span>
00075 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00076 <span class="preprocessor"></span>
00077 
00078 <span class="preprocessor">#include "iostats.h"</span>
00079 <span class="preprocessor">#include "../common/utils.h"</span>
00080 <span class="preprocessor">#include "../common/semaphore.h"</span>
00081 <span class="preprocessor">#include "../common/mutex.h"</span>
00082 <span class="comment">//#include "../common/rwlock.h"</span>
00083 <span class="preprocessor">#include "../common/switch.h"</span>
00084 <span class="preprocessor">#include "../common/state.h"</span>
00085 <span class="preprocessor">#include "completion_handler.h"</span>
00086 
00087 __STXXL_BEGIN_NAMESPACE
00088 
00093 
00094 <span class="preprocessor">#define BLOCK_ALIGN 4096</span>
00095 <span class="preprocessor"></span>
00096         <span class="keyword">typedef</span> <span class="keywordtype">void</span> *(*thread_function_t) (<span class="keywordtype">void</span> *);
00097         <span class="keyword">typedef</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> DISKID;
00098 
00099         <span class="keyword">class </span>request;
00100   <span class="keyword">class </span>request_ptr;
00101         
00103         
<a name="l00104"></a><a class="code" href="structstxxl_1_1default__completion__handler.html">00104</a>         <span class="keyword">struct </span><a class="code" href="structstxxl_1_1default__completion__handler.html">default_completion_handler</a>
00105         {
<a name="l00107"></a><a class="code" href="structstxxl_1_1default__completion__handler.html#a0">00107</a>                 <span class="keywordtype">void</span> operator() (<a class="code" href="classstxxl_1_1request.html">request</a> *) { };
00108         };
00109 
00111         
<a name="l00114"></a><a class="code" href="classstxxl_1_1file.html">00114</a>         <span class="keyword">class </span><a class="code" href="classstxxl_1_1file.html">file</a>
00115         {
00118                 <a class="code" href="classstxxl_1_1file.html">file</a> ()
00119                 {
00120                 };
00121                 
00122         <span class="keyword">protected</span>:
00123                 <span class="keywordtype">int</span> id;
00124                 
<a name="l00128"></a><a class="code" href="classstxxl_1_1file.html#b0">00128</a>                 <a class="code" href="classstxxl_1_1file.html">file</a> (<span class="keywordtype">int</span> _id):id (_id) { };
00129                 
00130         <span class="keyword">public</span>:
00132                 
<a name="l00135"></a><a class="code" href="classstxxl_1_1file.html#w6">00135</a>                 <span class="keyword">enum</span> open_mode
00136                 { 
00137                                 RDONLY = 1, 
00138                                 WRONLY = 2, 
00139                                 RDWR = 4,   
00140                                 CREAT = 8,  
00141                                 DIRECT = 16,
00142                                 TRUNC = 32  
00143                 };
00144 
00151                 <span class="keyword">virtual</span> <a class="code" href="classstxxl_1_1request__ptr.html">request_ptr</a> aread (<span class="keywordtype">void</span> *buffer, off_t pos, size_t bytes,
00152                                     <a class="code" href="classstxxl_1_1completion__handler.html">completion_handler</a> on_cmpl ) = 0;
00159                 <span class="keyword">virtual</span> <a class="code" href="classstxxl_1_1request__ptr.html">request_ptr</a> awrite (<span class="keywordtype">void</span> *buffer, off_t pos, size_t bytes, 
00160             <a class="code" href="classstxxl_1_1completion__handler.html">completion_handler</a> on_cmpl ) = 0;
00161 
00164                 <span class="keyword">virtual</span> <span class="keywordtype">void</span> set_size (off_t newsize) = 0;
00167                 <span class="keyword">virtual</span> off_t size () = 0;
<a name="l00169"></a><a class="code" href="classstxxl_1_1file.html#a4">00169</a>                 <span class="keywordtype">int</span> get_disk_number () 
00170                 {
00171                         <span class="keywordflow">return</span> id;
00172                 };
<a name="l00176"></a><a class="code" href="classstxxl_1_1file.html#a5">00176</a>                 <span class="keywordtype">int</span> get_id()
00177                 {
00178                         <span class="keywordflow">return</span> id;
00179                 };
00180                 <span class="keyword">virtual</span> ~ file () { };
00181         };
00182 
00183         <span class="keyword">class </span>mc;
00184         <span class="keyword">class </span>disk_queue;
00185         <span class="keyword">class </span>disk_queues;
00186 
00188         
<a name="l00192"></a><a class="code" href="classstxxl_1_1request.html">00192</a>         <span class="keyword">class </span><a class="code" href="classstxxl_1_1request.html">request</a>
00193         {
00194     <span class="keyword">friend</span> <span class="keywordtype">int</span> <a class="code" href="group__iolayer.html#a2">wait_any</a>(<a class="code" href="classstxxl_1_1request__ptr.html">request_ptr</a> req_array[], <span class="keywordtype">int</span> count);
00195     <span class="keyword">template</span> &lt;<span class="keyword">class</span> request_iterator_&gt; <span class="keyword">friend</span> 
00196     request_iterator_ <a class="code" href="group__iolayer.html#a2">wait_any</a>(request_iterator_ reqs_begin, request_iterator_ reqs_end);
00197                 <span class="keyword">friend</span> <span class="keyword">class </span><a class="code" href="classstxxl_1_1file.html">file</a>;
00198                 <span class="keyword">friend</span> <span class="keyword">class </span>disk_queue;
00199                 <span class="keyword">friend</span> <span class="keyword">class </span><a class="code" href="classstxxl_1_1disk__queues.html">disk_queues</a>;
00200     <span class="keyword">friend</span> <span class="keyword">class </span><a class="code" href="classstxxl_1_1request__ptr.html">request_ptr</a>;
00201                 
00202         <span class="keyword">protected</span>:
00203                 <span class="keyword">virtual</span> <span class="keywordtype">bool</span> add_waiter (onoff_switch * sw) = 0;
00204                 <span class="keyword">virtual</span> <span class="keywordtype">void</span> delete_waiter (onoff_switch * sw) = 0;
00205                 <span class="comment">//virtual void enqueue () = 0;</span>
00206                 <span class="keyword">virtual</span> <span class="keywordtype">void</span> serve () = 0;
00207         
00208                 <a class="code" href="classstxxl_1_1completion__handler.html">completion_handler</a> on_complete;
00209                 <span class="keywordtype">int</span> ref_cnt;
00210     mutex ref_cnt_mutex;
00211     
00212                 <span class="keyword">enum</span> request_type { READ, WRITE };
00213                 
00214                 <span class="keywordtype">void</span> completed ()
00215                 {
00216                         on_complete(<span class="keyword">this</span>);
00217                 };
00218                 
00219         <span class="keyword">public</span>:
00220                 <a class="code" href="classstxxl_1_1request.html">request</a>(<a class="code" href="classstxxl_1_1completion__handler.html">completion_handler</a> on_compl):on_complete(on_compl),ref_cnt(0)
00221     {
00222       STXXL_VERBOSE3(<span class="stringliteral">"request "</span>&lt;&lt; <span class="keywordtype">unsigned</span>(<span class="keyword">this</span>) &lt;&lt;<span class="stringliteral">": creation, cnt: "</span>&lt;&lt;ref_cnt)
00223     }
00225                 <span class="keyword">virtual</span> <span class="keywordtype">void</span> wait () = 0;
00228                 <span class="keyword">virtual</span> <span class="keywordtype">bool</span> poll () = 0;
<a name="l00231"></a><a class="code" href="classstxxl_1_1request.html#a3">00231</a>                 <span class="keyword">virtual</span> <span class="keyword">const</span> <span class="keywordtype">char</span> * io_type ()
00232                 {
00233                         <span class="keywordflow">return</span> <span class="stringliteral">"none"</span>;
00234                 };
00235                 <span class="keyword">virtual</span> ~<a class="code" href="classstxxl_1_1request.html">request</a>()
00236     {
00237         STXXL_VERBOSE3(<span class="stringliteral">"request "</span>&lt;&lt; <span class="keywordtype">unsigned</span>(<span class="keyword">this</span>) &lt;&lt;<span class="stringliteral">": deletion, cnt: "</span>&lt;&lt;ref_cnt)
00238     }
00239         <span class="keyword">private</span>:
00240     <span class="comment">// Following methods are declared but not implemented </span>
00241     <span class="comment">// intentionnaly to forbid their usage</span>
00242                 request(<span class="keyword">const</span> request &amp;);
00243     request &amp; operator=(<span class="keyword">const</span> request &amp;);
00244                 request();
00245     
00246     <span class="keywordtype">void</span> add_ref()
00247     {
00248       ref_cnt_mutex.lock();
00249       STXXL_VERBOSE3(<span class="stringliteral">"request "</span>&lt;&lt; <span class="keywordtype">unsigned</span>(<span class="keyword">this</span>) &lt;&lt;<span class="stringliteral">": adding reference, cnt: "</span>&lt;&lt;ref_cnt)
00250       ref_cnt++;
00251       ref_cnt_mutex.unlock();
00252     }
00253     <span class="keywordtype">bool</span> sub_ref()
00254     {
00255       ref_cnt_mutex.lock();
00256       STXXL_VERBOSE3(<span class="stringliteral">"request "</span>&lt;&lt; <span class="keywordtype">unsigned</span>(<span class="keyword">this</span>) &lt;&lt;<span class="stringliteral">": subtracting reference cnt: "</span>&lt;&lt;ref_cnt)
00257       <span class="keywordtype">int</span> val=--ref_cnt;
00258       ref_cnt_mutex.unlock();
00259       assert(val&gt;=0);
00260       <span class="keywordflow">return</span> (val==0);
00261     }
00262         };
00263 
00265   
<a name="l00267"></a><a class="code" href="classstxxl_1_1request__ptr.html">00267</a>   <span class="keyword">class </span><a class="code" href="classstxxl_1_1request__ptr.html">request_ptr</a>
00268   {
00269     <a class="code" href="classstxxl_1_1request.html">request</a> * ptr;
00270     <span class="keywordtype">void</span> add_ref()
00271     {
00272       <span class="keywordflow">if</span>(ptr)
00273       {
00274         ptr-&gt;add_ref();
00275       }
00276     }
00277     <span class="keywordtype">void</span> sub_ref()
00278     {
00279       <span class="keywordflow">if</span>(ptr)
00280       {
00281         <span class="keywordflow">if</span>(ptr-&gt;sub_ref())
00282         {
00283           <span class="keyword">delete</span> ptr;
00284           ptr = NULL;
00285         }
00286       }
00287     }
00288   <span class="keyword">public</span>:
<a name="l00290"></a><a class="code" href="classstxxl_1_1request__ptr.html#a0">00290</a>     <a class="code" href="classstxxl_1_1request__ptr.html">request_ptr</a>(<a class="code" href="classstxxl_1_1request.html">request</a> *ptr_=NULL):ptr(ptr_) { add_ref(); }
<a name="l00292"></a><a class="code" href="classstxxl_1_1request__ptr.html#a1">00292</a>     <a class="code" href="classstxxl_1_1request__ptr.html">request_ptr</a>(<span class="keyword">const</span> <a class="code" href="classstxxl_1_1request__ptr.html">request_ptr</a> &amp; p): ptr(p.ptr) { add_ref(); }
<a name="l00294"></a><a class="code" href="classstxxl_1_1request__ptr.html#a2">00294</a>     ~<a class="code" href="classstxxl_1_1request__ptr.html">request_ptr</a>() { sub_ref(); }
<a name="l00297"></a><a class="code" href="classstxxl_1_1request__ptr.html#a3">00297</a>     <a class="code" href="classstxxl_1_1request__ptr.html">request_ptr</a> &amp; operator= (<span class="keyword">const</span> <a class="code" href="classstxxl_1_1request__ptr.html">request_ptr</a> &amp; p)
00298     {
00299       assert(p.<a class="code" href="classstxxl_1_1request__ptr.html#r0">ptr</a>);
00300       <span class="keywordflow">return</span> (*<span class="keyword">this</span> = p.<a class="code" href="classstxxl_1_1request__ptr.html#r0">ptr</a>);
00301     }
<a name="l00304"></a><a class="code" href="classstxxl_1_1request__ptr.html#a4">00304</a>     <a class="code" href="classstxxl_1_1request__ptr.html">request_ptr</a> &amp; operator= (<a class="code" href="classstxxl_1_1request.html">request</a> * p)
00305     {
00306       <span class="keywordflow">if</span>(p != ptr)
00307       {
00308         sub_ref();
00309         ptr = p;
00310         add_ref();
00311       }
00312       <span class="keywordflow">return</span> *<span class="keyword">this</span>;
00313     }
<a name="l00316"></a><a class="code" href="classstxxl_1_1request__ptr.html#a5">00316</a>     <a class="code" href="classstxxl_1_1request.html">request</a> &amp; operator * ()<span class="keyword"> const</span>
00317 <span class="keyword">    </span>{
00318       assert(ptr);
00319       <span class="keywordflow">return</span> *ptr;
00320     }
<a name="l00323"></a><a class="code" href="classstxxl_1_1request__ptr.html#a6">00323</a>     <a class="code" href="classstxxl_1_1request.html">request</a> * operator -&gt; ()<span class="keyword"> const</span>
00324 <span class="keyword">    </span>{
00325       assert(ptr);
00326       <span class="keywordflow">return</span> ptr;
00327     }
<a name="l00332"></a><a class="code" href="classstxxl_1_1request__ptr.html#a7">00332</a>     <a class="code" href="classstxxl_1_1request.html">request</a> * get()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> ptr; }
00333     
<a name="l00335"></a><a class="code" href="classstxxl_1_1request__ptr.html#a8">00335</a>     <span class="keywordtype">bool</span> valid()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> ptr; }
00336     
<a name="l00338"></a><a class="code" href="classstxxl_1_1request__ptr.html#a9">00338</a>     <span class="keywordtype">bool</span> empty()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> !ptr; }
00339   };
00340   
00342         
00347   <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="group__iolayer.html#a2">wait_any</a>(request_ptr req_array[], <span class="keywordtype">int</span> count);
00351   <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="group__iolayer.html#a3">wait_all</a>(request_ptr req_array[], <span class="keywordtype">int</span> count);
00357   <span class="keyword">inline</span> <span class="keywordtype">bool</span> <a class="code" href="group__iolayer.html#a4">poll_any</a> (request_ptr req_array[], <span class="keywordtype">int</span> count,<span class="keywordtype">int</span> &amp;index);
00358   
00359   
<a name="l00360"></a><a class="code" href="group__iolayer.html#a3">00360</a>   <span class="keywordtype">void</span> <a class="code" href="group__iolayer.html#a3">wait_all</a>(request_ptr req_array[], <span class="keywordtype">int</span> count)
00361         {
00362                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; count; i++)
00363                 {
00364                         req_array[i]-&gt;wait ();
00365                 }
00366         }
00367   
00368   <span class="keyword">template</span> &lt;<span class="keyword">class</span> request_iterator_&gt;
00369   <span class="keywordtype">void</span> <a class="code" href="group__iolayer.html#a3">wait_all</a>(request_iterator_ reqs_begin, request_iterator_ reqs_end)
00370         {
00371     <span class="keywordflow">while</span>(reqs_begin != reqs_end)
00372     {
00373                         (request_ptr(*reqs_begin))-&gt;wait ();
00374       ++reqs_begin;
00375     }
00376         }
00377   
<a name="l00378"></a><a class="code" href="group__iolayer.html#a4">00378</a>         <span class="keywordtype">bool</span> <a class="code" href="group__iolayer.html#a4">poll_any</a> (request_ptr req_array[], <span class="keywordtype">int</span> count, <span class="keywordtype">int</span> &amp;index)
00379         {
00380                 index = -1;
00381                 <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; count; i++)
00382                 {
00383                         <span class="keywordflow">if</span> (req_array[i]-&gt;poll())
00384                         {
00385                                 index = i;
00386                                 <span class="keywordflow">return</span> <span class="keyword">true</span>;
00387                         }
00388                 };
00389                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00390         }
00391   
00392   <span class="keyword">template</span> &lt;<span class="keyword">class</span> request_iterator_&gt;
00393   request_iterator_ <a class="code" href="group__iolayer.html#a4">poll_any</a>(request_iterator_ reqs_begin, request_iterator_ reqs_end)
00394         {
00395                 <span class="keywordflow">while</span>(reqs_begin != reqs_end)
00396                 {
00397                         <span class="keywordflow">if</span> ((request_ptr(*reqs_begin))-&gt;poll())
00398                                 <span class="keywordflow">return</span> reqs_begin;
00399                         ++reqs_begin;
00400                 };
00401                 <span class="keywordflow">return</span> reqs_end;
00402         }
00403   
00404 
<a name="l00405"></a><a class="code" href="group__iolayer.html#a2">00405</a>         <span class="keywordtype">int</span> <a class="code" href="group__iolayer.html#a2">wait_any</a> (request_ptr req_array[], <span class="keywordtype">int</span> count)
00406         {
00407                 START_COUNT_WAIT_TIME
00408                 onoff_switch sw;
00409                 <span class="keywordtype">int</span> i = 0, index = -1;
00410 
00411                 <span class="keywordflow">for</span> (; i &lt; count; i++)
00412                 {
00413                         <span class="keywordflow">if</span> (req_array[i]-&gt;add_waiter (&amp;sw))
00414                         {
00415                                 <span class="comment">// already done</span>
00416                                 index = i;
00417 
00418                                 <span class="keywordflow">while</span> (--i &gt;= 0)
00419                                         req_array[i]-&gt;delete_waiter (&amp;sw);
00420 
00421                                 END_COUNT_WAIT_TIME
00422                                 <span class="keywordflow">return</span> index;
00423                         }
00424                 }
00425 
00426                 sw.wait_for_on ();
00427 
00428                 <span class="keywordflow">for</span> (i = 0; i &lt; count; i++)
00429                 {
00430                         req_array[i]-&gt;delete_waiter (&amp;sw);
00431                         <span class="keywordflow">if</span> (index &lt; 0 &amp;&amp; req_array[i]-&gt;poll ())
00432                                 index = i;
00433                 }
00434 
00435                 END_COUNT_WAIT_TIME
00436                 <span class="keywordflow">return</span> index;
00437         }
00438   
00439   <span class="keyword">template</span> &lt;<span class="keyword">class</span> request_iterator_&gt;
00440   request_iterator_ <a class="code" href="group__iolayer.html#a2">wait_any</a>(request_iterator_ reqs_begin, request_iterator_ reqs_end)
00441         {
00442                 START_COUNT_WAIT_TIME
00443                 onoff_switch sw;
00444                 
00445     request_iterator_ cur = reqs_begin, result = reqs_end;
00446     
00447                 <span class="keywordflow">for</span> (; cur != reqs_end; cur++)
00448                 {
00449                         <span class="keywordflow">if</span> ((request_ptr(*cur))-&gt;add_waiter (&amp;sw))
00450                         {
00451                                 <span class="comment">// already done</span>
00452                                 result = cur;
00453 
00454         <span class="keywordflow">if</span>(cur != reqs_begin)
00455         {
00456           <span class="keywordflow">while</span> (--cur != reqs_begin)
00457             (request_ptr(*cur))-&gt;delete_waiter (&amp;sw);
00458           (request_ptr(*cur))-&gt;delete_waiter (&amp;sw);
00459         }
00460 
00461                                 END_COUNT_WAIT_TIME
00462                                 <span class="keywordflow">return</span> result;
00463                         }
00464                 }
00465 
00466                 sw.wait_for_on ();
00467 
00468                 <span class="keywordflow">for</span> (cur = reqs_begin; cur != reqs_end; cur++)
00469                 {
00470                         (request_ptr(*cur))-&gt;delete_waiter (&amp;sw);
00471                         <span class="keywordflow">if</span> (result == reqs_end &amp;&amp; (request_ptr(*cur))-&gt;poll ())
00472                                 result = cur;
00473                 }
00474 
00475                 END_COUNT_WAIT_TIME
00476                 <span class="keywordflow">return</span> result;
00477         }
00478 
00479         <span class="keyword">class </span>disk_queue
00480         {
00481         <span class="keyword">public</span>:
00482                 <span class="keyword">enum</span> priority_op { READ, WRITE, NONE };
00483         <span class="keyword">private</span>:
00484                 mutex write_mutex;
00485                 mutex read_mutex;
00486                 std::queue &lt; request_ptr &gt; write_queue;
00487                 std::queue &lt; request_ptr &gt; read_queue;
00488                 semaphore sem;
00489                 pthread_t thread;
00490                 priority_op _priority_op;
00491 
00492 <span class="preprocessor">#ifdef STXXL_IO_STATS</span>
00493 <span class="preprocessor"></span>                stats *iostats;
00494 <span class="preprocessor">#endif</span>
00495 <span class="preprocessor"></span>
00496                 <span class="keyword">static</span> <span class="keywordtype">void</span> *worker (<span class="keywordtype">void</span> *arg);
00497         <span class="keyword">public</span>:
00498                 disk_queue (<span class="keywordtype">int</span> n = 1); <span class="comment">// max number of requests simultainenously submitted to disk</span>
00499                 
00500                 <span class="keywordtype">void</span> set_priority_op (priority_op op)
00501                 {
00502                         _priority_op = op;
00503                 };
00504                 <span class="keywordtype">void</span> add_readreq (request_ptr &amp; req);
00505                 <span class="keywordtype">void</span> add_writereq (request_ptr &amp; req);
00506                 ~disk_queue ();
00507         };
00508 
<a name="l00511"></a><a class="code" href="classstxxl_1_1disk__queues.html">00511</a>         <span class="keyword">class </span><a class="code" href="classstxxl_1_1disk__queues.html">disk_queues</a>
00512         {
00513         <span class="keyword">protected</span>:
00514                 std::map &lt; DISKID, disk_queue * &gt; queues;
00515                 <a class="code" href="classstxxl_1_1disk__queues.html">disk_queues</a> ()
00516                 {
00517                 };
00518         <span class="keyword">public</span>:
00519                 <span class="keywordtype">void</span> add_readreq (<a class="code" href="classstxxl_1_1request__ptr.html">request_ptr</a> &amp; req, DISKID disk)
00520                 {
00521                         <span class="keywordflow">if</span> (queues.find (disk) == queues.end ())
00522                         {
00523                                 <span class="comment">// create new disk queue</span>
00524                                 queues[disk] = <span class="keyword">new</span> disk_queue ();
00525                         }
00526                         queues[disk]-&gt;add_readreq (req);
00527                 };
00528                 <span class="keywordtype">void</span> add_writereq (<a class="code" href="classstxxl_1_1request__ptr.html">request_ptr</a> &amp; req, DISKID disk)
00529                 {
00530                         <span class="keywordflow">if</span> (queues.find (disk) == queues.end ())
00531                         {
00532                                 <span class="comment">// create new disk queue</span>
00533                                 queues[disk] = <span class="keyword">new</span> disk_queue ();
00534                         }
00535                         queues[disk]-&gt;add_writereq (req);
00536                 };
00537                 ~<a class="code" href="classstxxl_1_1disk__queues.html">disk_queues</a> ()
00538                 {
00539                         <span class="comment">// deallocate all queues</span>
00540                         <span class="keywordflow">for</span> (std::map &lt; DISKID, disk_queue * &gt;::iterator i =
00541                              queues.begin (); i != queues.end (); i++)
00542                                 <span class="keyword">delete</span> (*i).second;
00543                 };
00544                 <span class="keyword">static</span> <a class="code" href="classstxxl_1_1disk__queues.html">disk_queues</a> *get_instance ()
00545                 {
00546                         <span class="keywordflow">if</span> (!instance)
00547                                 instance = <span class="keyword">new</span> <a class="code" href="classstxxl_1_1disk__queues.html">disk_queues</a> ();
00548 
00549                         <span class="keywordflow">return</span> instance;
00550                 };
<a name="l00556"></a><a class="code" href="classstxxl_1_1disk__queues.html#a3">00556</a>                 <span class="keywordtype">void</span> set_priority_op(disk_queue::priority_op op)
00557                 {
00558                         <span class="keywordflow">for</span> (std::map &lt; DISKID, disk_queue * &gt;::iterator i =
00559                              queues.begin (); i != queues.end (); i++)
00560                                 i-&gt;second-&gt;set_priority_op (op);
00561                 };
00562         <span class="keyword">private</span>:
00563                 <span class="keyword">static</span> <a class="code" href="classstxxl_1_1disk__queues.html">disk_queues</a> *instance;
00564         };
00565 
00566 <span class="preprocessor">#ifdef COUNT_WAIT_TIME</span>
00567 <span class="preprocessor"></span>        <span class="keyword">extern</span> <span class="keywordtype">double</span> wait_time_counter;
00568 <span class="preprocessor">#endif</span>
00569 <span class="preprocessor"></span>
00571   
00572 __STXXL_END_NAMESPACE
00573 
00574 
00575 <span class="preprocessor">#endif</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Nov 26 10:56:52 2003 for <stxxl> by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.4 </small></address>
</body>
</html>
