<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>&lt;stxxl&gt;: prefetch_pool.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a> | <a class="qindex" href="examples.html">Examples</a></div>
<h1>prefetch_pool.h</h1><div class="fragment"><pre>00001 <span class="preprocessor"> #ifndef PREFETCH_POOL_HEADER</span>
00002 <span class="preprocessor"></span><span class="preprocessor"> #define PREFETCH_POOL_HEADER</span>
00003 <span class="preprocessor"></span> <span class="comment">/***************************************************************************</span>
00004 <span class="comment"> *            prefetch_pool.h</span>
00005 <span class="comment"> *</span>
00006 <span class="comment"> *  Thu Jul  3 11:08:09 2003</span>
00007 <span class="comment"> *  Copyright  2003  Roman Dementiev</span>
00008 <span class="comment"> *  dementiev@mpi-sb.mpg.de</span>
00009 <span class="comment"> ****************************************************************************/</span>
00010 <span class="preprocessor">#include "../common/utils.h"</span>
00011 <span class="preprocessor">#include "../mng/mng.h"</span>
00012 <span class="preprocessor">#include "write_pool.h"</span>
00013 <span class="preprocessor">#include &lt;list&gt;</span>
00014 <span class="preprocessor">#include &lt;ext/hash_map&gt;</span>
00015 
00016 __STXXL_BEGIN_NAMESPACE
00017 
00020   
00022 <span class="keyword">template</span> &lt;<span class="keyword">class</span> BlockType&gt;
<a name="l00023"></a><a class="code" href="classstxxl_1_1prefetch__pool.html">00023</a> <span class="keyword">class </span><a class="code" href="classstxxl_1_1prefetch__pool.html">prefetch_pool</a>
00024 {
00025 <span class="keyword">public</span>:
00026   <span class="keyword">typedef</span> BlockType block_type;
00027   <span class="keyword">typedef</span> <span class="keyword">typename</span> block_type::bid_type bid_type;
00028   
00029 <span class="keyword">protected</span>:
00030   <span class="keyword">struct </span>bid_hash
00031   {
00032     size_t operator()(<span class="keyword">const</span> bid_type &amp; bid)<span class="keyword"> const</span>
00033 <span class="keyword">    </span>{
00034       size_t result = size_t(bid.storage) + 
00035         size_t(bid.offset &amp; 0xffffffff) + size_t(bid.offset&gt;&gt;32);
00036       <span class="keywordflow">return</span> result;
00037     }
00038   };
00039   <span class="keyword">typedef</span> std::pair&lt;block_type *,request_ptr&gt; busy_entry;
00040   <span class="keyword">typedef</span> __gnu_cxx::hash_map &lt; bid_type, busy_entry , bid_hash &gt; hash_map_type;
00041   <span class="keyword">typedef</span> <span class="keyword">typename</span> std::list&lt;block_type *&gt;::iterator free_blocks_iterator;
00042   <span class="keyword">typedef</span> <span class="keyword">typename</span> hash_map_type::iterator busy_blocks_iterator;
00043   
00044   <span class="comment">// contains free prefetch blocks</span>
00045   std::list&lt;block_type *&gt; free_blocks;
00046   <span class="comment">// blocks that are in reading or already read but not retrieved by user</span>
00047   hash_map_type busy_blocks;
00048   
00049   <span class="keywordtype">unsigned</span> free_blocks_size;
00050 <span class="keyword">public</span>:
00051   
<a name="l00054"></a><a class="code" href="classstxxl_1_1prefetch__pool.html#a0">00054</a>   <span class="keyword">explicit</span> <a class="code" href="classstxxl_1_1prefetch__pool.html">prefetch_pool</a>(<span class="keywordtype">unsigned</span> init_size=1): free_blocks_size(init_size)
00055   {
00056     <span class="keywordtype">unsigned</span> i = 0;
00057     <span class="keywordflow">for</span>(;i&lt;init_size;++i)
00058       free_blocks.push_back(<span class="keyword">new</span> block_type);
00059   }
00060   
<a name="l00062"></a><a class="code" href="classstxxl_1_1prefetch__pool.html#a1">00062</a>   <span class="keyword">virtual</span> ~<a class="code" href="classstxxl_1_1prefetch__pool.html">prefetch_pool</a>()
00063   {
00064     <span class="keywordflow">while</span>(!free_blocks.empty())
00065     {
00066       <span class="keyword">delete</span> free_blocks.back();
00067       free_blocks.pop_back();
00068     }
00069     
00070     busy_blocks_iterator i2 = busy_blocks.begin();
00071     <span class="keywordflow">for</span>(;i2 != busy_blocks.end();++i2)
00072     {
00073       i2-&gt;second.second-&gt;wait();
00074       <span class="keyword">delete</span> i2-&gt;second.first;
00075     }
00076   }
<a name="l00078"></a><a class="code" href="classstxxl_1_1prefetch__pool.html#a2">00078</a>   <span class="keywordtype">unsigned</span> size()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> free_blocks_size + busy_blocks.size(); }
00079   
<a name="l00087"></a><a class="code" href="classstxxl_1_1prefetch__pool.html#a3">00087</a>   <span class="keywordtype">bool</span> hint(bid_type bid)
00088   {
00089     <span class="comment">// if block is already hinted, no need to hint it again</span>
00090     <span class="keywordflow">if</span>(busy_blocks.find(bid) != busy_blocks.end())
00091       <span class="keywordflow">return</span> <span class="keyword">true</span>;
00092     
00093     <span class="keywordflow">if</span>(free_blocks_size) <span class="comment">//  only if we have a free block</span>
00094     {
00095       STXXL_VERBOSE2(<span class="stringliteral">"prefetch_pool::hint bid= "</span> &lt;&lt; bid&lt;&lt;<span class="stringliteral">" =&gt; prefetching"</span>)
00096       
00097       --free_blocks_size;
00098       block_type * block = free_blocks.back();
00099       free_blocks.pop_back();
00100       <a class="code" href="classstxxl_1_1request__ptr.html">request_ptr</a> req = block-&gt;read(bid);
00101       busy_blocks[bid] = busy_entry(block,req);
00102       <span class="keywordflow">return</span> <span class="keyword">true</span>;
00103     }
00104     STXXL_VERBOSE2(<span class="stringliteral">"prefetch_pool::hint bid="</span> &lt;&lt; bid&lt;&lt;<span class="stringliteral">" =&gt; no free blocks for prefetching"</span>)
00105     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00106   }
00107   
00108   <span class="keywordtype">bool</span> hint(bid_type bid, <a class="code" href="classstxxl_1_1write__pool.html">write_pool&lt;block_type&gt;</a> &amp; w_pool)
00109   {
00110     <span class="comment">// if block is already hinted, no need to hint it again</span>
00111     <span class="keywordflow">if</span>(busy_blocks.find(bid) != busy_blocks.end())
00112       <span class="keywordflow">return</span> <span class="keyword">true</span>;
00113     
00114     <span class="keywordflow">if</span>(free_blocks_size) <span class="comment">//  only if we have a free block</span>
00115     {
00116       STXXL_VERBOSE2(<span class="stringliteral">"prefetch_pool::hint2 bid= "</span> &lt;&lt; bid&lt;&lt;<span class="stringliteral">" =&gt; prefetching"</span>)
00117       --free_blocks_size;
00118       block_type * block = free_blocks.back();
00119       free_blocks.pop_back();
00120       <a class="code" href="classstxxl_1_1request__ptr.html">request_ptr</a> req = w_pool.<a class="code" href="classstxxl_1_1write__pool.html#a7">get_request</a>(bid);
00121       <span class="keywordflow">if</span>(req.<a class="code" href="classstxxl_1_1request__ptr.html#a8">valid</a>())
00122       {
00123          STXXL_VERBOSE2(<span class="stringliteral">"prefetch_pool::hint2 bid= "</span> &lt;&lt; bid&lt;&lt;<span class="stringliteral">" was in write cache"</span>)
00124          block_type * w_block = w_pool.<a class="code" href="classstxxl_1_1write__pool.html#a4">steal</a>(bid);
00125          assert(w_block != 0);
00126          w_pool.<a class="code" href="classstxxl_1_1write__pool.html#a9">add</a>(block);
00127          busy_blocks[bid] = busy_entry(w_block,req);
00128          <span class="keywordflow">return</span> <span class="keyword">true</span>;
00129       }
00130       req = block-&gt;read(bid);
00131       busy_blocks[bid] = busy_entry(block,req);
00132       <span class="keywordflow">return</span> <span class="keyword">true</span>;
00133     }
00134     STXXL_VERBOSE2(<span class="stringliteral">"prefetch_pool::hint2 bid="</span> &lt;&lt; bid&lt;&lt;<span class="stringliteral">" =&gt; no free blocks for prefetching"</span>)
00135     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00136   }
00137   
00138   <span class="keywordtype">bool</span> in_prefetching(bid_type bid)
00139   {
00140     <span class="keywordflow">return</span> (busy_blocks.find(bid) != busy_blocks.end());
00141   }
00142   
<a name="l00149"></a><a class="code" href="classstxxl_1_1prefetch__pool.html#a6">00149</a>   <a class="code" href="classstxxl_1_1request__ptr.html">request_ptr</a> read(block_type * &amp; block, bid_type bid)
00150   {
00151     busy_blocks_iterator cache_el = busy_blocks.find(bid);
00152     <span class="keywordflow">if</span>(cache_el == busy_blocks.end())
00153     {
00154       <span class="comment">// not cached</span>
00155       STXXL_VERBOSE2(<span class="stringliteral">"prefetch_pool::read bid="</span>&lt;&lt;bid&lt;&lt;<span class="stringliteral">" =&gt; no copy in cache, retrieving"</span>)
00156       <span class="keywordflow">return</span> block-&gt;read(bid);
00157     }
00158     
00159     <span class="comment">// cached</span>
00160     STXXL_VERBOSE2(<span class="stringliteral">"prefetch_pool::read bid="</span>&lt;&lt;bid&lt;&lt;<span class="stringliteral">" =&gt; copy in cache exists"</span>)
00161     ++free_blocks_size;
00162     free_blocks.push_back(block);
00163     block = cache_el-&gt;second.first;
00164     <a class="code" href="classstxxl_1_1request__ptr.html">request_ptr</a> result = cache_el-&gt;second.second;
00165     busy_blocks.erase(cache_el);
00166     <span class="keywordflow">return</span> result;
00167   }
00168   
<a name="l00175"></a><a class="code" href="classstxxl_1_1prefetch__pool.html#a7">00175</a>   <span class="keywordtype">unsigned</span> resize(<span class="keywordtype">unsigned</span> new_size)
00176   {
00177     <span class="keywordtype">int</span> diff = int(new_size) - int(size());
00178     <span class="keywordflow">if</span>(diff &gt; 0)
00179     {
00180       free_blocks_size += diff;
00181       <span class="keywordflow">while</span>(--diff &gt;= 0)
00182         free_blocks.push_back(<span class="keyword">new</span> block_type);
00183       
00184       <span class="keywordflow">return</span> size();
00185     } 
00186     
00187     <span class="keywordflow">while</span>(diff &lt; 0 &amp;&amp; free_blocks_size &gt; 0)
00188     {
00189       ++diff;
00190       --free_blocks_size;
00191       <span class="keyword">delete</span> free_blocks.back();
00192       free_blocks.pop_back();
00193     }
00194     <span class="keywordflow">return</span> size();
00195   }
00196 };
00197 
00199 
00200 __STXXL_END_NAMESPACE
00201 
00202 <span class="preprocessor">#endif</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Fri Nov 21 15:28:11 2003 for <stxxl> by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.4 </small></address>
</body>
</html>
