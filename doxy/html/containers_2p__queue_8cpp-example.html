<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>&lt;stxxl&gt;: Example Documentation</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a> | <a class="qindex" href="examples.html">Examples</a></div>
<h1>containers/p_queue.cpp</h1>This is an example of how to use <code><a class="el" href="classstxxl_1_1PRIORITY__QUEUE__GENERATOR.html">stxxl::PRIORITY_QUEUE_GENERATOR</a></code> and <code><a class="el" href="classstxxl_1_1priority__queue.html">stxxl::priority_queue</a></code> <div class="fragment"><pre> <span class="comment">/***************************************************************************</span>
<span class="comment"> *            p_queue.cpp</span>
<span class="comment"> *</span>
<span class="comment"> *  Fri Jul  4 11:31:34 2003</span>
<span class="comment"> *  Copyright  2003  Roman Dementiev</span>
<span class="comment"> *  dementiev@mpi-sb.mpg.de</span>
<span class="comment"> ****************************************************************************/</span>
<span class="preprocessor">#include "priority_queue.h"</span>
<span class="preprocessor">#include "../common/timer.h"</span>
<span class="keyword">using</span> <span class="keyword">namespace </span>stxxl;


<span class="keyword">struct </span>my_type
{
    <span class="keyword">typedef</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> key_type;
  <span class="comment">//typedef int key_type;</span>
        key_type key;
        <span class="keywordtype">char</span> data[128 - <span class="keyword">sizeof</span>(key_type)];
        my_type(){}
        <span class="keyword">explicit</span> my_type(key_type k):key(k) {}
};

std::ostream &amp; operator &lt;&lt; (std::ostream &amp; o,<span class="keyword">const</span> my_type &amp; obj)
{
        o &lt;&lt; obj.key;
        <span class="keywordflow">return</span> o;
}

<span class="comment">//typedef int my_type;</span>

<span class="keyword">struct </span>dummy_merger
{
  <span class="keywordtype">int</span> &amp; cnt;
  dummy_merger(<span class="keywordtype">int</span> &amp; c):cnt(c) {}
  <span class="keyword">template</span> &lt;<span class="keyword">class</span> OutputIterator&gt;
  <span class="keywordtype">void</span> multi_merge(OutputIterator b,OutputIterator e)
  {
    <span class="keywordflow">while</span>(b!=e)
    {
      *b = cnt;
      ++b;
      ++cnt;
    }
  }
};

<span class="keyword">struct </span>my_cmp <span class="comment">// greater</span>
{
  <span class="keywordtype">bool</span> operator () (<span class="keyword">const</span> my_type &amp; a, <span class="keyword">const</span> my_type &amp; b)<span class="keyword"> const </span>{ <span class="keywordflow">return</span> a.key &gt; b.key; }
  my_type min_value()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> my_type(std::numeric_limits&lt;my_type::key_type&gt;::max()); }
  
}; 
<span class="comment">/*</span>
<span class="comment">struct my_cmp: public std::greater&lt;my_type&gt;</span>
<span class="comment">{</span>
<span class="comment">  my_type min_value() const { return my_type(std::numeric_limits&lt;my_type&gt;::max()); }</span>
<span class="comment">  my_type max_value() const { return my_type(std::numeric_limits&lt;my_type&gt;::min()); }</span>
<span class="comment">};*/</span>


<span class="keywordtype">int</span> main()
{<span class="comment">/*</span>
<span class="comment">      unsigned BufferSize1_ = 32, // equalize procedure call overheads etc. </span>
<span class="comment">      unsigned N_ = 512, // bandwidth</span>
<span class="comment">      unsigned IntKMAX_ = 64, // maximal arity for internal mergers</span>
<span class="comment">      unsigned IntLevels_ = 4, </span>
<span class="comment">      unsigned BlockSize_ = (2*1024*1024),</span>
<span class="comment">      unsigned ExtKMAX_ = 64, // maximal arity for external mergers</span>
<span class="comment">      unsigned ExtLevels_ = 2,</span>
<span class="comment">  */</span>
  <span class="comment">//typedef priority_queue&lt;priority_queue_config&lt;my_type,my_cmp,</span>
  <span class="comment">//  32,512,64,3,(4*1024),0x7fffffff,1&gt; &gt; pq_type;</span>
  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> volume = 255*1024; <span class="comment">// in KB</span>
  <span class="keyword">typedef</span> PRIORITY_QUEUE_GENERATOR&lt;my_type,my_cmp,64*1024*1024,volume/<span class="keyword">sizeof</span>(my_type)&gt; gen;
  <span class="keyword">typedef</span> gen::result pq_type;
  <span class="keyword">typedef</span> pq_type::block_type block_type;
 
  STXXL_MSG(<span class="stringliteral">"Block size: "</span>&lt;&lt;block_type::raw_size)
  <span class="comment">//STXXL_MSG(settings::EConsumption);</span>
  <span class="comment">/*</span>
<span class="comment">  STXXL_MSG(settings::AE);</span>
<span class="comment">  STXXL_MSG(settings::settings::B); */</span>
  STXXL_MSG(<span class="stringliteral">"AI: "</span>&lt;&lt;gen::AI);
  STXXL_MSG(<span class="stringliteral">"X : "</span>&lt;&lt;gen::X);
  STXXL_MSG(<span class="stringliteral">"N : "</span>&lt;&lt;gen::N);
  STXXL_MSG(<span class="stringliteral">"AE: "</span>&lt;&lt;gen::AE);
 
  timer Timer;
  Timer.start();
  
  <span class="keyword">const</span> <span class="keywordtype">unsigned</span> mem_for_pools = 128*1024*1024;
  prefetch_pool&lt;block_type&gt; p_pool((mem_for_pools/2)/block_type::raw_size);
  write_pool&lt;block_type&gt;    w_pool((mem_for_pools/2)/block_type::raw_size);
  pq_type p(p_pool,w_pool);
  off_t nelements = off_t(volume/<span class="keyword">sizeof</span>(my_type))*1024,i;
  STXXL_MSG(<span class="stringliteral">"Internal memory consumption of the priority queue: "</span>&lt;&lt;p.mem_cons()&lt;&lt;<span class="stringliteral">" bytes"</span>)
  STXXL_MSG(<span class="stringliteral">"Max elements: "</span>&lt;&lt;nelements)
  <span class="keywordflow">for</span>(i = 0;i&lt;nelements ;i++ )
  {
    <span class="keywordflow">if</span>((i%(1024*1024)) == 0)
                STXXL_MSG(<span class="stringliteral">"Inserting element "</span>&lt;&lt;i)
    p.push(my_type(nelements - i));
  }
  Timer.stop();
  STXXL_MSG(<span class="stringliteral">"Time spent for filling: "</span>&lt;&lt;Timer.seconds()&lt;&lt; <span class="stringliteral">" sec"</span>)
  
  STXXL_MSG(<span class="stringliteral">"Internal memory consumption of the priority queue: "</span>&lt;&lt;p.mem_cons()&lt;&lt;<span class="stringliteral">" bytes"</span>)
  Timer.reset();
  Timer.start();
  <span class="keywordflow">for</span>(i = 0; i&lt;(nelements) ;++i )
  {
    assert( !p.empty() );
    <span class="comment">//STXXL_MSG( p.top() )</span>
    assert(p.top().key == i+1);
    p.pop();
    <span class="keywordflow">if</span>((i%(1024*1024)) == 0)
      STXXL_MSG(<span class="stringliteral">"Element "</span>&lt;&lt;i&lt;&lt;<span class="stringliteral">" popped"</span>)
  }
  Timer.stop();
  STXXL_MSG(<span class="stringliteral">"Time spent for removing elements: "</span>&lt;&lt;Timer.seconds()&lt;&lt; <span class="stringliteral">" sec"</span>)
  STXXL_MSG(<span class="stringliteral">"Internal memory consumption of the priority queue: "</span>&lt;&lt;p.mem_cons()&lt;&lt;<span class="stringliteral">" bytes"</span>)
  
}
</pre></div> <hr size="1"><address style="align: right;"><small>Generated on Fri Nov 21 15:28:10 2003 for <stxxl> by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.4 </small></address>
</body>
</html>
