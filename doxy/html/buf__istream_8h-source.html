<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>&lt;stxxl&gt;: buf_istream.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a> | <a class="qindex" href="examples.html">Examples</a></div>
<h1>buf_istream.h</h1><div class="fragment"><pre>00001 <span class="preprocessor">#ifndef BUF_ISTREAM_HEADER</span>
00002 <span class="preprocessor"></span><span class="preprocessor">#define BUF_ISTREAM_HEADER</span>
00003 <span class="preprocessor"></span>
00004 <span class="comment">/***************************************************************************</span>
00005 <span class="comment"> *            buf_istream.h</span>
00006 <span class="comment"> *</span>
00007 <span class="comment"> *  Tue Dec 31 17:50:47 2002</span>
00008 <span class="comment"> *  Copyright  2002  Roman Dementiev</span>
00009 <span class="comment"> *  dementiev@mpi-sb.mpg.de</span>
00010 <span class="comment"> ****************************************************************************/</span>
00011 
00012 <span class="preprocessor">#include "../mng/block_prefetcher.h"</span>
00013 <span class="preprocessor">#include "../algo/async_schedule.h"</span>
00014 
00015 __STXXL_BEGIN_NAMESPACE
00016 
00019 
00020 
00021 
00022 <span class="comment">// a paranoic check</span>
00023 <span class="preprocessor">#define BUF_ISTREAM_CHECK_END</span>
00024 <span class="preprocessor"></span>
00025 
00030 <span class="keyword">template</span> &lt;<span class="keyword">typename</span> BlkTp_,<span class="keyword">typename</span> BIDIteratorTp_&gt;
<a name="l00031"></a><a class="code" href="classstxxl_1_1buf__istream.html">00031</a> <span class="keyword">class </span><a class="code" href="classstxxl_1_1buf__istream.html">buf_istream</a>
00032 {
00033         <span class="keyword">typedef</span> BlkTp_ block_type;
00034         <span class="keyword">typedef</span> BIDIteratorTp_ bid_iterator_type;
00035         
00036         <a class="code" href="classstxxl_1_1buf__istream.html">buf_istream</a>() {}
00037 <span class="keyword">protected</span>:
00038         <span class="keyword">typedef</span> <a class="code" href="classstxxl_1_1block__prefetcher.html">block_prefetcher&lt;block_type,bid_iterator_type&gt;</a> <a class="code" href="classstxxl_1_1block__prefetcher.html">prefetcher_type</a>;
00039         <a class="code" href="classstxxl_1_1block__prefetcher.html">prefetcher_type</a> * prefetcher;
00040         bid_iterator_type begin_bid,end_bid;
00041         <span class="keywordtype">int</span> current_elem;
00042         block_type * current_blk;
00043         <span class="keywordtype">int</span> * prefetch_seq;
00044 <span class="preprocessor">#ifdef BUF_ISTREAM_CHECK_END</span>
00045 <span class="preprocessor"></span>        <span class="keywordtype">bool</span> not_finished;
00046 <span class="preprocessor">#endif</span>
00047 <span class="preprocessor"></span><span class="keyword">public</span>:
00048         <span class="keyword">typedef</span> <span class="keyword">typename</span> block_type::reference reference;
00049         <span class="keyword">typedef</span> <a class="code" href="classstxxl_1_1buf__istream.html">buf_istream&lt;block_type,bid_iterator_type&gt;</a> <a class="code" href="classstxxl_1_1buf__istream.html">_Self</a>;
00050         
<a name="l00055"></a><a class="code" href="classstxxl_1_1buf__istream.html#a0">00055</a>         <a class="code" href="classstxxl_1_1buf__istream.html">buf_istream</a>(bid_iterator_type _begin,bid_iterator_type _end,<span class="keywordtype">int</span> nbuffers):
00056                 current_elem(0)
00057 #ifdef BUF_ISTREAM_CHECK_END
00058                 ,not_finished(true)
00059 #endif
00060         {
00061                 <span class="comment">//int i;</span>
00062                 <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ndisks = config::get_instance()-&gt;disks_number();
00063                 <span class="keyword">const</span> <span class="keywordtype">int</span> seq_length = _end - _begin;
00064                 prefetch_seq = <span class="keyword">new</span> <span class="keywordtype">int</span>[seq_length];
00065                 
00066                 <span class="comment">// obvious schedule</span>
00067                 <span class="comment">//for(i = 0; i&lt; seq_length; i++)</span>
00068                 <span class="comment">//      prefetch_seq[i] = i;</span>
00069                 
00070                 <span class="comment">// optimal schedule</span>
00071                 compute_prefetch_schedule(_begin,_end,prefetch_seq,
00072                         STXXL_MIN(2*ndisks,<span class="keywordtype">unsigned</span>(nbuffers - 1)),ndisks);
00073                 
00074                 prefetcher = <span class="keyword">new</span> <a class="code" href="classstxxl_1_1block__prefetcher.html">prefetcher_type</a>(_begin,_end,prefetch_seq,nbuffers);
00075                 
00076                 current_blk = prefetcher-&gt;pull_block();
00077         }
00078         
<a name="l00083"></a><a class="code" href="classstxxl_1_1buf__istream.html#a1">00083</a>         <a class="code" href="classstxxl_1_1buf__istream.html">_Self</a> &amp; operator &gt;&gt; (reference record)
00084         {
00085 <span class="preprocessor">#ifdef BUF_ISTREAM_CHECK_END</span>
00086 <span class="preprocessor"></span>                assert(not_finished);
00087 <span class="preprocessor">#endif</span>
00088 <span class="preprocessor"></span>                
00089                 record = current_blk-&gt;elem[current_elem++];
00090                 
00091                 <span class="keywordflow">if</span>(current_elem &gt;= block_type::size)
00092                 {
00093                         current_elem = 0;
00094 <span class="preprocessor">#ifdef BUF_ISTREAM_CHECK_END</span>
00095 <span class="preprocessor"></span>                        not_finished = prefetcher-&gt;block_consumed(current_blk);
00096 <span class="preprocessor">#else                   </span>
00097 <span class="preprocessor"></span>                        prefetcher-&gt;block_consumed(current_blk);
00098 <span class="preprocessor">#endif</span>
00099 <span class="preprocessor"></span>                }
00100                 
00101                 <span class="keywordflow">return</span> (*this);
00102         }
00103         
<a name="l00106"></a><a class="code" href="classstxxl_1_1buf__istream.html#a2">00106</a>         reference current() <span class="comment">/* const */</span>
00107         {
00108                 <span class="keywordflow">return</span> current_blk-&gt;elem[current_elem];
00109         }
00110         
<a name="l00113"></a><a class="code" href="classstxxl_1_1buf__istream.html#a3">00113</a>         reference operator *() <span class="comment">/* const */</span>
00114         {
00115                 <span class="keywordflow">return</span> current_blk-&gt;elem[current_elem];
00116         }
00117   
<a name="l00120"></a><a class="code" href="classstxxl_1_1buf__istream.html#a4">00120</a>         <a class="code" href="classstxxl_1_1buf__istream.html">_Self</a> &amp; operator ++()
00121         {
00122 <span class="preprocessor">                #ifdef BUF_ISTREAM_CHECK_END</span>
00123 <span class="preprocessor"></span>                assert(not_finished);
00124 <span class="preprocessor">                #endif</span>
00125 <span class="preprocessor"></span>                
00126                 current_elem++;
00127                 
00128                 <span class="keywordflow">if</span>(current_elem &gt;= block_type::size)
00129                 {
00130                         current_elem = 0;
00131 <span class="preprocessor">                        #ifdef BUF_ISTREAM_CHECK_END</span>
00132 <span class="preprocessor"></span>                        not_finished = prefetcher-&gt;block_consumed(current_blk);
00133 <span class="preprocessor">                        #else                   </span>
00134 <span class="preprocessor"></span>                        prefetcher-&gt;block_consumed(current_blk);
00135 <span class="preprocessor">                        #endif</span>
00136 <span class="preprocessor"></span>                }
00137                 <span class="keywordflow">return</span> *<span class="keyword">this</span>;
00138         }
00139         
<a name="l00141"></a><a class="code" href="classstxxl_1_1buf__istream.html#a5">00141</a>         <span class="keyword">virtual</span> ~<a class="code" href="classstxxl_1_1buf__istream.html">buf_istream</a>()
00142         {
00143                 <span class="keyword">delete</span> prefetcher;
00144                 <span class="keyword">delete</span> [] prefetch_seq;
00145         }
00146         
00147 };
00148 
00150 
00151 __STXXL_END_NAMESPACE
00152 
00153 <span class="preprocessor">#endif</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Fri Nov 21 15:28:10 2003 for <stxxl> by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.4 </small></address>
</body>
</html>
